<h1>Flux "mot de passe oubliÃ©" avec WeWeb + Brevo</h1>

<p><em>Dans cet article, je dÃ©taille la mise en place complÃ¨te d'un flux de rÃ©initialisation de mot de passe en utilisant WeWeb pour l'interface, Brevo pour l'envoi d'emails transactionnels, et une API custom pour la gestion des utilisateurs. Je partage les problÃ¨mes rencontrÃ©s et les solutions fonctionnelles.</em></p>

<!-- Metadata block -->
<div class="metadata">
    <p>ğŸ·ï¸ <strong>CatÃ©gorie :</strong> WeWeb</p>
    <p>ğŸ¯ <strong>Niveau :</strong> IntermÃ©diaire</p>
    <p>ğŸ” <strong>Mots-clÃ©s :</strong> Reset password, Forgot password, WeWeb validation, Regex JavaScript, Brevo transactional email, Query parameters, Magic link, Password policy, Formula condition, Brevo params</p>
    <p>ğŸ“… <strong>Mise Ã  jour :</strong> 04/02/2026</p>
    <p>â±ï¸ <strong>Temps passÃ© :</strong> 15min</p>
    <p>âš™ï¸ <strong>Stack :</strong> WeWeb + Brevo + API custom</p>
</div>

<!-- TL;DR -->
<div class="tldr">
âœ… <strong>TL;DR :</strong>
Pour crÃ©er un flux de rÃ©initialisation de mot de passe fonctionnel avec WeWeb + Brevo, les points critiques sont : (1) valider le mot de passe avec une regex correcte en utilisant <code>.test()</code>, (2) passer les paramÃ¨tres via <code>params</code> dans l'API Brevo, (3) rÃ©cupÃ©rer le <code>user_id</code> depuis l'URL WeWeb avec les query parameters, et (4) Ã©viter les erreurs JS courantes (comparaison de regex, syntaxe stricte).
</div>

<h2>ğŸ¤” ProblÃ¨me rencontrÃ©</h2>

<p><strong>ğŸ›‘ Besoin initial :</strong></p>
<ul>
    <li>CrÃ©er un formulaire d'inscription/rÃ©initialisation dans WeWeb</li>
    <li>Valider un mot de passe complexe (min 8 caractÃ¨res, minuscule, majuscule, chiffre, caractÃ¨re spÃ©cial)</li>
    <li>Envoyer un email via Brevo contenant un lien avec un identifiant utilisateur</li>
    <li>RÃ©cupÃ©rer cet identifiant dans une page WeWeb pour permettre le reset</li>
</ul>

<p><strong>ğŸ’¡ ScÃ©nario utilisateur :</strong></p>
<p>Un utilisateur clique sur "Mot de passe oubliÃ©" â†’ saisit son email â†’ reÃ§oit un lien par email â†’ clique sur le lien â†’ arrive sur une page WeWeb avec son <code>user_id</code> en paramÃ¨tre â†’ peut dÃ©finir un nouveau mot de passe.</p>

<h2>ğŸ” Les erreurs rencontrÃ©es (et pourquoi Ã§a ne marchait pas)</h2>

<h3>âŒ Erreur 1 : Comparer une valeur Ã  une regex</h3>
<pre><code>// âŒ INCORRECT
PasswordInputValue = ^(?=.*[A-Z])...
</code></pre>
<p>â¡ï¸ <strong>ProblÃ¨me :</strong> Une regex ne se compare pas avec <code>=</code>, elle se teste avec <code>.test()</code></p>

<h3>âŒ Erreur 2 : Regex interprÃ©tÃ©e comme du JavaScript invalide</h3>
<p>La regex Ã©tait Ã©crite directement dans une condition sans Ãªtre encapsulÃ©e correctement, provoquant une erreur <code>Unexpected token '^'</code>.</p>

<h3>âŒ Erreur 3 : Soustraction au lieu de lecture de variable</h3>
<pre><code>// âŒ INCORRECT
.test(variables[...] - value)
</code></pre>
<p>â¡ï¸ <strong>ProblÃ¨me :</strong> Le <code>- value</code> Ã©tait interprÃ©tÃ© comme une soustraction, retournant <code>NaN</code>, donc <code>.test(NaN)</code> retournait toujours <code>false</code>.</p>

<h3>âŒ Erreur 4 : Comparer Ã  la chaÃ®ne "null"</h3>
<pre><code>// âŒ INCORRECT
value != "null"
</code></pre>
<p>â¡ï¸ <strong>ProblÃ¨me :</strong> <code>"null"</code> est une chaÃ®ne de caractÃ¨res, pas une valeur vide. Il faut utiliser <code>null</code> sans guillemets.</p>

<div class="callout callout-warning">
âš ï¸ <strong>Attention</strong><br>
WeWeb est trÃ¨s permissif dans l'Ã©diteur de formules, mais exÃ©cute du JavaScript strict. Les erreurs de syntaxe JS ne sont souvent dÃ©tectÃ©es qu'Ã  l'exÃ©cution, pas Ã  la saisie.
</div>

<h2>âœ… Solution fonctionnelle : validation du mot de passe</h2>

<h3>ğŸ”§ Regex finale (copiable)</h3>
<pre><code>^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z0-9])\S{8,}$
</code></pre>

<p><strong>Explications :</strong></p>
<ul>
    <li><code>^</code> : dÃ©but de la chaÃ®ne</li>
    <li><code>(?=.*[a-z])</code> : au moins 1 minuscule</li>
    <li><code>(?=.*[A-Z])</code> : au moins 1 majuscule</li>
    <li><code>(?=.*\d)</code> : au moins 1 chiffre</li>
    <li><code>(?=.*[^A-Za-z0-9])</code> : au moins 1 caractÃ¨re spÃ©cial</li>
    <li><code>\S{8,}</code> : 8 caractÃ¨res minimum sans espace</li>
    <li><code>$</code> : fin de la chaÃ®ne</li>
</ul>

<h3>âœ… Condition WeWeb complÃ¨te (copiable)</h3>
<pre><code>variables['cd6eda7b-6d67-4942-8c56-3b362840e7b5-value'] === true
&& variables['138d3a19-97fb-4fa3-96d8-51dd46f0567a-value'] != null
&& variables['138d3a19-97fb-4fa3-96d8-51dd46f0567a-value'] !== ""
&& variables['686eba83-ed14-4f23-82cc-7d1d0af5df88-value'] != null
&& variables['686eba83-ed14-4f23-82cc-7d1d0af5df88-value'] !== ""
&& variables['5c149008-50e7-49e9-a4f6-460d7e10350f-value'] != null
&& variables['5c149008-50e7-49e9-a4f6-460d7e10350f-value'] !== ""
&& variables['22638315-a261-4d55-bbc0-7866ec8375e1-value'] != null
&& variables['22638315-a261-4d55-bbc0-7866ec8375e1-value'] !== ""
&& variables['dc33a746-5c44-46d4-99b1-93c37caf0297-value'] != null
&& variables['dc33a746-5c44-46d4-99b1-93c37caf0297-value'] !== ""
&& /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z0-9])\S{8,}$/
   .test(variables['dc33a746-5c44-46d4-99b1-93c37caf0297-value'])
</code></pre>

<div class="callout callout-tip">
âœ¨ <strong>Astuce</strong><br>
Utilisez <code>===</code> et <code>!==</code> pour des comparaisons strictes en JavaScript. VÃ©rifiez toujours <code>!= null</code> ET <code>!== ""</code> pour les champs texte, car une chaÃ®ne vide n'est pas <code>null</code>.
</div>

<h3>ğŸ’¬ Message utilisateur (UX-friendly)</h3>
<p>Affichez ce message dans un Snackbar ou popup en cas d'erreur de validation :</p>
<div class="callout callout-warning">
âš ï¸ <strong>Mot de passe invalide</strong><br>
8 caractÃ¨res minimum, avec au moins 1 minuscule, 1 majuscule, 1 chiffre et 1 caractÃ¨re spÃ©cial.<br>
Les espaces ne sont pas autorisÃ©s.
</div>

<h2>ğŸ“§ Envoi de l'email via Brevo avec passage de paramÃ¨tres</h2>

<h3>Ã‰tape 1ï¸âƒ£ : PrÃ©parer l'appel API dans WeWeb</h3>

<p>Dans votre workflow WeWeb, configurez un appel API vers Brevo en passant le <code>user_id</code> :</p>

<pre><code>|set: "params": ({})
  |set: "user_id": $user1.id
)
</code></pre>

<p>Cela crÃ©e un objet <code>params</code> contenant <code>user_id</code> qui sera envoyÃ© Ã  Brevo.</p>

<h3>Ã‰tape 2ï¸âƒ£ : Configurer le template Brevo</h3>

<p>Dans votre template d'email Brevo, insÃ©rez le paramÃ¨tre dans l'URL du bouton/lien :</p>

<pre><code>https://votre-app.weweb-preview.io/reset-password/?user_id={{ params.user_id }}
</code></pre>

<p>âœ… Brevo remplacera automatiquement <code>{{ params.user_id }}</code> par la valeur envoyÃ©e depuis WeWeb.</p>

<div class="callout callout-advanced">
ğŸ”¬ <strong>Pour aller plus loin</strong><br>
Vous pouvez passer plusieurs paramÃ¨tres : <code>{{ params.user_id }}</code>, <code>{{ params.token }}</code>, <code>{{ params.timestamp }}</code>, etc. Brevo supporte tous les paramÃ¨tres personnalisÃ©s envoyÃ©s dans l'objet <code>params</code>.
</div>

<h2>ğŸ”— RÃ©cupÃ©ration du paramÃ¨tre cÃ´tÃ© WeWeb</h2>

<h3>Ã‰tape 3ï¸âƒ£ : Lire le query parameter dans WeWeb</h3>

<p>Dans votre page de rÃ©initialisation, rÃ©cupÃ©rez le <code>user_id</code> depuis l'URL :</p>

<ul>
    <li>CrÃ©ez une variable WeWeb liÃ©e au query parameter <code>user_id</code></li>
    <li>Utilisez cette variable dans vos workflows (affichage, appel API, vÃ©rification utilisateur)</li>
</ul>

<div class="callout callout-warning">
âš ï¸ <strong>SÃ©curitÃ©</strong><br>
Passer le <code>user_id</code> directement dans l'URL est fonctionnel mais <strong>non sÃ©curisÃ©</strong> pour de la production. Pour un systÃ¨me robuste, utilisez un <strong>token JWT</strong> ou un <strong>magic link</strong> avec expiration. Cette mÃ©thode est acceptable pour du prototypage ou des environnements contrÃ´lÃ©s.
</div>

<h2>ğŸ“Š Bonus : Clic sur une ligne de DataGrid WeWeb</h2>

<p><strong>ProblÃ¨me :</strong> WeWeb n'offre pas de "on row click" direct exploitable facilement.</p>

<p><strong>Solution :</strong></p>
<ol>
    <li>Ajoutez un bouton ou container cliquable dans une cellule</li>
    <li>Au clic, stockez la ligne dans une variable (<code>selectedRow</code>)</li>
    <li>DÃ©clenchez un workflow avec une condition sur le statut</li>
</ol>

<pre><code>// Condition pour vÃ©rifier le statut "Brouillon"
(variables['56e3bdfa-2a56-42ca-8ff3-53f2eb734e5d-selectedRows']?.[0]?.status ?? "") === "Brouillon"
</code></pre>

<h2>ğŸ§­ Exemple complet du flux</h2>

<h3>1. Formulaire WeWeb (page "Mot de passe oubliÃ©")</h3>
<ul>
    <li>Champ email</li>
    <li>Bouton "Envoyer le lien"</li>
    <li>Workflow : appel API â†’ envoi email Brevo avec <code>params.user_id</code></li>
</ul>

<h3>2. Template Brevo</h3>
<pre><code>Bonjour,

Cliquez sur le lien ci-dessous pour rÃ©initialiser votre mot de passe :

[RÃ©initialiser mon mot de passe](https://votre-app.weweb-preview.io/reset-password/?user_id={{ params.user_id }})

Ce lien est valable pendant 24 heures.
</code></pre>

<h3>3. Page WeWeb "RÃ©initialisation"</h3>
<ul>
    <li>RÃ©cupÃ©ration du <code>user_id</code> depuis l'URL</li>
    <li>Formulaire avec nouveau mot de passe (validation regex)</li>
    <li>Bouton "Valider" â†’ appel API pour update password</li>
</ul>

<!-- Final summary -->
<div class="summary">
ğŸ“Œ <strong>Ã€ retenir :</strong>
<ul>
  <li>Utilisez <code>.test()</code> pour tester une regex en JavaScript, jamais <code>=</code></li>
  <li>VÃ©rifiez toujours <code>!= null</code> ET <code>!== ""</code> pour les champs texte</li>
  <li>Passez les paramÃ¨tres Ã  Brevo via l'objet <code>params</code> dans l'API call</li>
  <li>RÃ©cupÃ©rez les query parameters WeWeb pour lire les donnÃ©es de l'URL</li>
  <li>Passer un <code>user_id</code> en clair dans l'URL est fonctionnel mais non sÃ©curisÃ© en production</li>
  <li>Pour un DataGrid, ajoutez un bouton cliquable dans une cellule plutÃ´t que de compter sur un "row click" direct</li>
</ul>
</div>

<h2>ğŸ”— Liens utiles</h2>
<ul>
    <li><a href="https://docs.weweb.io/workflows/actions.html" target="_blank">Documentation WeWeb : Workflows et Actions</a></li>
    <li><a href="https://developers.brevo.com/docs/send-a-transactional-email" target="_blank">Documentation Brevo : Envoyer un email transactionnel</a></li>
    <li><a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Guide/Regular_Expressions" target="_blank">MDN : Expressions rÃ©guliÃ¨res JavaScript</a></li>
    <li><a href="https://regex101.com/" target="_blank">Regex101 : Testeur de regex en ligne</a></li>
</ul>
