<h1>WeWeb ‚Äì Journal de debug : Scroll, conditions m√©tier, calculs et g√©n√©ration PDF</h1>

<!-- Metadata block -->
<div class="metadata">
    <p>üè∑Ô∏è <strong>Cat√©gorie:</strong> WeWeb</p>
    <p>üéØ <strong>Niveau:</strong> Interm√©diaire</p>
    <p>üîç <strong>Mots-cl√©s:</strong> WeWeb debug, html2canvas, jsPDF pagination, scroll container, fixed header footer, JavaScript float precision, validation formulaire, capture DOM PDF, scale to fit PDF</p>
    <p>üìÖ <strong>Mise √† jour:</strong> 04/02/2026</p>
    <p>‚è±Ô∏è <strong>Temps pass√©:</strong> 15min</p>
    <p>‚öôÔ∏è <strong>Stack:</strong> WeWeb + html2canvas + jsPDF</p>
</div>

<!-- TL;DR -->
<div class="tldr">
‚úÖ <strong>TL;DR :</strong>
Journal technique documentant 6 probl√®mes r√©els rencontr√©s dans WeWeb : validation de champs incoh√©rente, scroll cass√© avec fixed header/footer, impr√©cision des calculs JS, bugs de pagination PDF, et leurs solutions test√©es et valid√©es.
</div>

<h2>üéØ Objectif de cet article</h2>
<p>Cet article documente les <strong>probl√®mes r√©els rencontr√©s</strong> lors du d√©veloppement d'une fonctionnalit√© de g√©n√©ration de PDF dans WeWeb, avec :</p>
<ul>
    <li>Les sympt√¥mes observ√©s</li>
    <li>Les hypoth√®ses test√©es</li>
    <li>Les √©checs et pourquoi</li>
    <li>Les solutions retenues et leurs raisons techniques</li>
</ul>

<div class="callout callout-tip">
‚ú® <strong>Astuce</strong><br>
Ce type de journal est pr√©cieux pour la formation : il montre le processus de debug r√©el, pas seulement le code final. Conservez ces traces pour progresser plus vite sur les prochains projets.
</div>

<h2>üõë Probl√®me #1 : Logique m√©tier (conditions true / false incoh√©rentes)</h2>

<h3>Sympt√¥me</h3>
<ul>
    <li>Une condition cens√©e bloquer l'action (<code>false</code>) passait quand m√™me √† <code>true</code></li>
    <li>Les champs <code>email</code> et <code>telephone</code> √©taient vides, mais la validation passait</li>
</ul>

<h3>Code initial (simplifi√©)</h3>
<pre><code>champ != null</code></pre>

<h3>Hypoth√®se</h3>
<p>"Peut-√™tre que la valeur n'est pas <code>null</code> mais autre chose"</p>

<h3>üîç Diagnostic</h3>
<p>En JavaScript :</p>
<ul>
    <li><code>""</code> (string vide) ‚â† <code>null</code></li>
    <li><code>" "</code> (espaces) ‚â† <code>null</code></li>
</ul>
<p>Donc <code>!= null</code> ne prot√®ge que contre <code>null</code> / <code>undefined</code></p>

<div class="callout callout-warning">
‚ö†Ô∏è <strong>Attention</strong><br>
<code>!= null</code> n'est JAMAIS une validation utilisateur suffisante. Une string vide ou contenant uniquement des espaces passera cette condition.
</div>

<h3>‚úÖ Test concluant</h3>
<pre><code>((value ?? '').trim() !== '')</code></pre>

<h3>D√©cision</h3>
<ul>
    <li>Toute validation utilisateur = <strong>non null + non vide + trim</strong></li>
    <li><code>!= null</code> r√©serv√© uniquement aux champs techniques</li>
</ul>

<h2>üõë Probl√®me #2 : Scroll cass√© (main passe sous le footer)</h2>

<h3>Sympt√¥me</h3>
<p>En scrollant vers le bas :</p>
<ul>
    <li>Le contenu du <code>main</code> passe derri√®re le <code>footer</code></li>
    <li><code>html2canvas</code> capture mal la zone</li>
</ul>

<h3>Contexte technique</h3>
<ul>
    <li><code>header</code> : <code>position: fixed</code></li>
    <li><code>footer</code> : <code>position: fixed</code></li>
    <li><code>main</code> : hauteur automatique</li>
    <li>Scroll global sur <code>body</code></li>
</ul>

<h3>Hypoth√®ses test√©es</h3>
<ol>
    <li>Ajouter des <code>z-index</code></li>
    <li>Passer le footer en <code>sticky</code></li>
    <li>Ajouter du <code>padding-bottom</code> au main</li>
</ol>
<p>‚û°Ô∏è <strong>R√©sultat :</strong> bricolage fragile, d√©pendant de la hauteur r√©elle du footer.</p>

<h3>üîç Diagnostic final</h3>
<ul>
    <li>Les √©l√©ments <code>fixed</code> ne r√©servent aucune place dans le flux</li>
    <li>Le <code>body</code> continue de scroller "sous" eux</li>
</ul>

<h3>‚úÖ Solution retenue : Layout en vh</h3>
<p>Scroll uniquement sur <code>main</code></p>

<h4>Impl√©mentation</h4>
<ul>
    <li><code>header</code> : hauteur fixe (vh / px)</li>
    <li><code>footer</code> : hauteur fixe</li>
    <li><code>main</code> :
        <ul>
            <li><code>height: calc(100vh - header - footer)</code></li>
            <li><code>overflow-y: auto</code></li>
        </ul>
    </li>
</ul>

<h4>Pourquoi √ßa marche</h4>
<ul>
    <li>Plus de scroll global</li>
    <li><code>html2canvas</code> peut mesurer un conteneur stable</li>
    <li>Plus de contenu masqu√©</li>
</ul>

<div class="callout callout-tip">
‚ú® <strong>Astuce</strong><br>
Avec un layout en <code>vh</code> et scroll sur <code>main</code>, les √©l√©ments fixed (header/footer) restent toujours visibles et le contenu ne passe plus dessous. C'est la solution standard pour les applications web modernes.
</div>

<h2>üõë Probl√®me #3 : Impr√©cision JS (0.6000000000000001)</h2>

<h3>Sympt√¥me</h3>
<p>Multiplication simple ‚Üí r√©sultat "bizarre"</p>

<h3>Cause</h3>
<p>Repr√©sentation float IEEE 754 (classique en JavaScript)</p>

<div class="figure">
    <pre><code>0.1 + 0.2 // 0.30000000000000004</code></pre>
    <p class="figure-caption">Exemple classique d'impr√©cision des flottants en JS</p>
</div>

<h3>‚úÖ Test concluant</h3>
<pre><code>Math.round(val * 100) / 100</code></pre>

<h3>D√©cision</h3>
<ul>
    <li>Tous les montants calcul√©s ‚Üí <strong>arrondis avant affichage</strong></li>
    <li><code>toFixed(2)</code> seulement pour l'affichage (retourne une string)</li>
</ul>

<div class="callout callout-advanced">
üî¨ <strong>Pour aller plus loin</strong><br>
Pour des calculs financiers pr√©cis, envisagez d'utiliser une biblioth√®que comme <code>decimal.js</code> ou <code>big.js</code> qui g√®rent les d√©cimales sans approximation.
</div>

<h2>üõë Probl√®me #4 : PDF d√©coupage entre pages cass√©</h2>

<h3>Sympt√¥me</h3>
<p>PDF multi-pages avec :</p>
<ul>
    <li>Blanc entre pages</li>
    <li>D√©calage vertical</li>
    <li>Contenu coup√© n'importe comment</li>
</ul>

<h3>Code test√© (approche classique)</h3>
<ul>
    <li>1 canvas g√©ant</li>
    <li>M√™me image coll√©e sur chaque page</li>
    <li>Offset Y recalcul√©</li>
</ul>

<h3>Hypoth√®se</h3>
<p>"Le calcul d'offset est faux"</p>

<h3>üîç Diagnostic r√©el</h3>
<ul>
    <li>jsPDF ne g√®re pas un scroll d'image</li>
    <li>Repositionner une image g√©ante = impr√©cis</li>
    <li>Erreurs cumul√©es d√®s que la hauteur tombe pile sur une page</li>
</ul>

<h3>Test alternatif (qui marche)</h3>
<ul>
    <li>D√©couper le canvas en tranches</li>
    <li>Une image = une page</li>
</ul>
<p>‚û°Ô∏è Rendu parfait, mais :</p>
<ul>
    <li>Multi-pages</li>
    <li>Pas le besoin m√©tier final</li>
</ul>

<div class="callout callout-warning">
‚ö†Ô∏è <strong>Attention</strong><br>
jsPDF n'est pas con√ßu pour simuler un scroll ou repositionner une grande image sur plusieurs pages. Cette approche g√©n√®re toujours des bugs d'alignement.
</div>

<h2>‚úÖ Probl√®me #5 : D√©cision produit ‚Äì Forcer sur une seule page</h2>

<h3>Besoin r√©el</h3>
<ul>
    <li>Un devis en une page</li>
    <li>Acceptable si r√©duit</li>
    <li>Z√©ro bug de pagination</li>
</ul>

<h3>Strat√©gie retenue</h3>
<ul>
    <li><strong>Scale to fit</strong></li>
    <li>Pas de pagination</li>
    <li>Pas de calcul d'offset</li>
    <li>Une seule image</li>
</ul>

<h3>Pourquoi √ßa marche</h3>
<ul>
    <li>jsPDF ne fait qu'afficher une image</li>
    <li>Aucune logique de page break</li>
    <li>Aucune jonction √† g√©rer</li>
</ul>

<div class="callout callout-tip">
‚ú® <strong>Astuce</strong><br>
Simplifier le besoin r√©sout souvent le bug. Une seule page = z√©ro calcul de pagination = z√©ro bug d'alignement.
</div>

<h2>üß∞ Probl√®me #6 : Script final ‚Äì Pourquoi il est stable</h2>

<h3>Points cl√©s de stabilit√©</h3>
<ul>
    <li><strong>Lock global</strong> (<code>__WW_PDF_LOCK__</code>) : emp√™che les clics multiples</li>
    <li><strong>Chargement CDN s√©curis√©</strong> : v√©rification que les libs sont charg√©es</li>
    <li><strong>Timeout html2canvas</strong> : laisse le temps au DOM de se stabiliser</li>
    <li><strong>Capture DOM ma√Ætris√©e</strong> : scroll local uniquement</li>
    <li><strong>Pas de pagination</strong> : une seule image ‚Üí une seule page</li>
</ul>

<p>‚û°Ô∏è <strong>Moins de logique = moins de bugs</strong></p>

<div class="summary">
üìå <strong>√Ä retenir :</strong>
<ul>
    <li><code>!= null</code> n'est jamais une validation utilisateur (toujours trim + v√©rifier vide)</li>
    <li><code>fixed</code> + scroll global = pi√®ge classique (pr√©f√©rer layout vh + scroll sur main)</li>
    <li><code>html2canvas</code> a besoin d'un DOM stable (pas de scroll body)</li>
    <li><code>jsPDF</code> n'est pas fait pour simuler un scroll ou une pagination complexe</li>
    <li>Simplifier le besoin (1 page au lieu de multi-pages) r√©sout souvent le bug</li>
    <li>Toujours arrondir les calculs JS avec des flottants avant affichage</li>
    <li>Documenter les hypoth√®ses test√©es permet d'apprendre de ses erreurs</li>
</ul>
</div>

<h2>üîó Ressources utiles</h2>
<ul>
    <li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">MDN : Number et pr√©cision des flottants</a></li>
    <li><a href="https://html2canvas.hertzen.com/" target="_blank">Documentation html2canvas</a></li>
    <li><a href="https://github.com/parallax/jsPDF" target="_blank">Documentation jsPDF</a></li>
    <li><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/position" target="_blank">MDN : position (fixed, sticky, etc.)</a></li>
</ul>
