<h1>G√©n√©rer un PDF depuis WeWeb : ce qui marche, ce qui casse, et pourquoi</h1>

<p class="subtitle">Analyse approfondie des diff√©rentes solutions pour g√©n√©rer un PDF c√¥t√© front dans WeWeb, avec leurs avantages, limites, et pi√®ges √† √©viter en production.</p>

<!-- Metadata block -->
<div class="metadata">
    <p>üè∑Ô∏è <strong>Cat√©gorie:</strong> WeWeb</p>
    <p>üéØ <strong>Niveau:</strong> Interm√©diaire</p>
    <p>üîç <strong>Mots-cl√©s:</strong> html2canvas, jsPDF, window.print(), G√©n√©ration PDF, Capture DOM, Performances front-end, CORS, Pagination A4</p>
    <p>üìÖ <strong>Mise √† jour:</strong> 27/01/2026</p>
    <p>‚è±Ô∏è <strong>Temps pass√©:</strong> 30min</p>
    <p>‚öôÔ∏è <strong>Stack:</strong> WeWeb</p>
</div>

<!-- TL;DR -->
<div class="tldr">
‚úÖ <strong>TL;DR :</strong>
G√©n√©rer un PDF c√¥t√© front dans WeWeb avec html2canvas + jsPDF fonctionne conceptuellement, mais n√©cessite des optimisations s√©rieuses (scale r√©duit, JPEG, lock d'ex√©cution, timeouts) pour √™tre utilisable en production. Pour des documents critiques ou complexes, un backend (Xano + Puppeteer) est recommand√©.
</div>

<h2>ü§î Probl√®me rencontr√©</h2>

<p><strong>üõë Objectif :</strong> g√©n√©rer un PDF (devis, facture) depuis une application WeWeb, √† partir d'un div HTML existant, sans backend (pas de Xano), avec :</p>

<ul>
    <li>un rendu fid√®le au visuel</li>
    <li>sans en-t√™tes/pieds de page navigateur</li>
    <li>sans intervention utilisateur</li>
    <li>avec pagination A4 correcte</li>
</ul>

<p><strong>‚öôÔ∏è Contraintes :</strong></p>
<ul>
    <li>environnement no-code / low-code (WeWeb)</li>
    <li>pas de bundler JS</li>
    <li>rendu front uniquement</li>
    <li>action d√©clench√©e par un bouton</li>
</ul>

<p><strong>üí° Exemple utilisateur :</strong> Un utilisateur remplit un formulaire de devis dans WeWeb, clique sur "T√©l√©charger PDF", et devrait recevoir imm√©diatement un document PDF propre, format√© en A4, sans headers/footers du navigateur.</p>

<h2>üîç Les diff√©rentes approches possibles</h2>

<h3>1Ô∏è‚É£ Approche 1 : <code>window.print()</code></h3>

<p><strong>Comment √ßa marche :</strong></p>
<p>La fonction native <code>window.print()</code> ouvre la bo√Æte de dialogue d'impression du navigateur. L'utilisateur peut ensuite choisir "Enregistrer en PDF".</p>

<p><strong>‚úÖ Avantages :</strong></p>
<ul>
    <li>Rapide et fid√®le au rendu visuel</li>
    <li>Aucune librairie externe</li>
    <li>Fonctionne imm√©diatement</li>
</ul>

<p><strong>‚ùå Inconv√©nients majeurs :</strong></p>
<ul>
    <li>Ajoute des en-t√™tes / pieds de page (date, URL, num√©ro de page)</li>
    <li>Impossible de les supprimer par code</li>
    <li>Comportement d√©pend du navigateur</li>
    <li>N√©cessite une action utilisateur manuelle ("d√©sactiver en-t√™tes")</li>
</ul>

<div class="callout callout-warning">
‚ö†Ô∏è <strong>Attention</strong><br>
<code>window.print()</code> n'est <strong>pas un g√©n√©rateur PDF programmable</strong>. C'est un outil d'impression, pas une solution pour g√©n√©rer automatiquement des documents PDF propres.
</div>

<h3>2Ô∏è‚É£ Approche 2 : <code>html2canvas + jsPDF</code></h3>

<p><strong>Comment √ßa marche :</strong></p>
<p>Cette stack est souvent enseign√©e dans les cours WeWeb car elle permet :</p>

<ul>
    <li>Une solution 100% front (pas de backend)</li>
    <li>G√©n√©ration directe d'un fichier PDF t√©l√©chargeable</li>
    <li>Automatisation compl√®te (1 clic = 1 PDF)</li>
    <li>Pagination contr√¥l√©e (format A4)</li>
</ul>

<p><strong>Le principe :</strong></p>
<ol>
    <li>Capture un div via <code>html2canvas</code> (convertit le DOM en image canvas)</li>
    <li>Convertit le canvas en image PNG/JPEG</li>
    <li>Ins√®re l'image dans un PDF A4 avec <code>jsPDF</code></li>
    <li>D√©coupe intelligemment les pages pour √©viter de couper des champs</li>
</ol>

<p><strong>‚úÖ Avantages :</strong></p>
<ul>
    <li>Solution p√©dagogique viable pour prototypes</li>
    <li>Contr√¥le total sur le rendu</li>
    <li>Pas de d√©pendance backend</li>
</ul>

<p><strong>‚ùå Inconv√©nients en production :</strong></p>
<ul>
    <li><strong>Performances catastrophiques</strong> : g√©n√©ration pouvant durer plusieurs minutes</li>
    <li><strong>Rendu incoh√©rent</strong> : proportions d√©form√©es, layout diff√©rent du navigateur</li>
    <li><strong>Comportement al√©atoire</strong> : parfois √ßa marche, parfois non</li>
    <li><strong>Blocages silencieux</strong> : images externes sans CORS, fonts pas charg√©es</li>
</ul>

<h2>üß™ Probl√®mes rencontr√©s en pratique avec html2canvas + jsPDF</h2>

<h3>4.1 Performances catastrophiques</h3>

<pre><code>// ‚ùå Configuration par d√©faut (d√©sastreuse)
html2canvas(element, {
    scale: 2,  // Canvas √©norme
    useCORS: true,
    imageTimeout: 0  // Pas de timeout
}).then(canvas => {
    // G√©n√©ration PNG = fichier lourd
    const imgData = canvas.toDataURL('image/png');
})
</code></pre>

<p><strong>Cons√©quences :</strong></p>
<ul>
    <li>Canvas √©norme (scale: 2 = 4x plus de pixels)</li>
    <li>G√©n√©ration pouvant durer plusieurs minutes</li>
    <li>Parfois blocage total (aucun PDF g√©n√©r√©)</li>
</ul>

<h3>4.2 Rendu incoh√©rent</h3>

<p>CSS WeWeb (flex, grid, transform) mal interpr√©t√© par html2canvas :</p>
<ul>
    <li>Proportions d√©form√©es</li>
    <li>Layout diff√©rent du navigateur</li>
    <li>√âl√©ments qui se chevauchent</li>
</ul>

<h3>4.3 Comportement al√©atoire</h3>

<ul>
    <li>Parfois √ßa marche, parfois non</li>
    <li>Spam du bouton ‚áí plusieurs g√©n√©rations en parall√®le</li>
    <li>T√©l√©chargement multiple ou aucun t√©l√©chargement</li>
</ul>

<h3>4.4 Blocages silencieux</h3>

<ul>
    <li>Images externes sans CORS (jamais charg√©es)</li>
    <li>Fonts web pas encore charg√©es</li>
    <li><code>html2canvas</code> qui ne rejette pas mais ne termine jamais</li>
</ul>

<h2>üîß Causes r√©elles des √©checs</h2>

<h3>5.1 Capture d'un mauvais conteneur</h3>

<p>Capturer un wrapper WeWeb au lieu du bloc "papier" :</p>
<ul>
    <li><code>scrollHeight</code> gigantesque</li>
    <li>Canvas trop lourd</li>
    <li>Freeze du navigateur</li>
</ul>

<div class="callout callout-tip">
‚ú® <strong>Astuce</strong><br>
Toujours cibler pr√©cis√©ment le div du devis, pas la page enti√®re. V√©rifier <code>scrollWidth</code> / <code>scrollHeight</code> avant capture.
</div>

<h3>5.2 Mauvais mapping mm ‚Üî px</h3>

<ul>
    <li>HTML responsive (%, vw)</li>
    <li>PDF en millim√®tres</li>
    <li>Sans largeur A4 fixe ‚Üí proportions cass√©es</li>
</ul>

<h3>5.3 Absence de verrou d'ex√©cution</h3>

<pre><code>// ‚ùå Sans protection
button.onClick(() => {
    generatePDF(); // Appel√© plusieurs fois en parall√®le
});
</code></pre>

<p><strong>Cons√©quences :</strong></p>
<ul>
    <li>Clics multiples = plusieurs exports simultan√©s</li>
    <li>M√©moire satur√©e</li>
    <li>Comportement impr√©visible</li>
</ul>

<h3>5.4 Attente infinie</h3>

<ul>
    <li>Images jamais charg√©es</li>
    <li>Fonts web lentes</li>
    <li>Aucun timeout ‚Üí script bloqu√©</li>
</ul>

<h2>‚úÖ Solutions qui fonctionnent r√©ellement</h2>

<h3>6.1 Toujours verrouiller l'ex√©cution</h3>

<pre><code>// ‚úÖ Avec lock global
let isGenerating = false;

button.onClick(async () => {
    if (isGenerating) {
        console.log('PDF d√©j√† en cours de g√©n√©ration');
        return;
    }

    isGenerating = true;
    try {
        await generatePDF();
    } finally {
        isGenerating = false;
    }
});
</code></pre>

<h3>6.2 Charger les librairies une seule fois</h3>

<p>Ne jamais recharger <code>html2canvas</code> / <code>jsPDF</code> √† chaque clic. Les charger au d√©marrage de l'app.</p>

<h3>6.3 R√©duire drastiquement le co√ªt de capture</h3>

<pre><code>// ‚úÖ Configuration optimis√©e
html2canvas(element, {
    scale: 1,  // Ou 1.25 max (jamais 2)
    useCORS: true,
    imageTimeout: 5000,  // Timeout de 5 secondes
    logging: false,
    backgroundColor: '#ffffff'
}).then(canvas => {
    // JPEG au lieu de PNG (beaucoup plus l√©ger)
    const imgData = canvas.toDataURL('image/jpeg', 0.95);
})
</code></pre>

<p><strong>Bonnes pratiques :</strong></p>
<ul>
    <li><code>scale</code> entre 1 et 1.25 (jamais 2 par d√©faut)</li>
    <li>JPEG au lieu de PNG</li>
    <li>Supprimer ombres, animations, filters CSS si possible</li>
</ul>

<h3>6.4 Cibler pr√©cis√©ment le devis</h3>

<ul>
    <li>Capturer le div du devis uniquement</li>
    <li>Pas la page enti√®re</li>
    <li>V√©rifier <code>scrollWidth</code> / <code>scrollHeight</code></li>
</ul>

<h3>6.5 Ajouter des timeouts</h3>

<pre><code>// ‚úÖ Avec timeout
async function generatePDF() {
    const element = document.querySelector('#devis-container');

    try {
        const canvas = await Promise.race([
            html2canvas(element, {
                scale: 1.25,
                imageTimeout: 5000
            }),
            new Promise((_, reject) =>
                setTimeout(() => reject(new Error('Timeout')), 15000)
            )
        ]);

        // Conversion en PDF...
    } catch (error) {
        console.error('√âchec g√©n√©ration PDF:', error);
        alert('Impossible de g√©n√©rer le PDF. Veuillez r√©essayer.');
    }
}
</code></pre>

<div class="callout callout-advanced">
üî¨ <strong>Pour aller plus loin</strong><br>
Pour des documents critiques (factures l√©gales, gros volumes, rendu pixel-perfect), il est recommand√© d'utiliser un backend (Xano + Puppeteer ou service HTML ‚Üí PDF) plut√¥t que html2canvas.
</div>

<h2>‚öñÔ∏è Limites structurelles de html2canvas</h2>

<p>M√™me bien optimis√©, html2canvas a des limites :</p>

<ul>
    <li>Ce n'est <strong>pas un moteur de rendu PDF</strong>, c'est une capture d'√©cran</li>
    <li>Lourd pour le navigateur (d√©pend du DOM, CSS, machine client)</li>
    <li>Rendu parfois diff√©rent du navigateur</li>
    <li>Probl√®mes avec CORS, fonts web, animations CSS</li>
</ul>

<div class="callout callout-warning">
‚ö†Ô∏è <strong>Attention</strong><br>
Pour des documents officiels (factures, contrats), un backend est <strong>fortement recommand√©</strong> pour garantir un rendu professionnel et conforme.
</div>

<h2>üß≠ Quand utiliser quoi ?</h2>

<table style="width: 100%; border-collapse: collapse; margin: 1rem 0;">
    <thead>
        <tr style="background-color: var(--primary-color); color: white;">
            <th style="padding: 0.75rem; text-align: left;">Solution</th>
            <th style="padding: 0.75rem; text-align: left;">Quand l'utiliser</th>
            <th style="padding: 0.75rem; text-align: left;">Limites</th>
        </tr>
    </thead>
    <tbody>
        <tr style="border-bottom: 1px solid var(--border-color);">
            <td style="padding: 0.75rem;"><strong>html2canvas + jsPDF</strong></td>
            <td style="padding: 0.75rem;">
                ‚Ä¢ 1‚Äì2 pages max<br>
                ‚Ä¢ Contenu simple<br>
                ‚Ä¢ Prototype / d√©mo<br>
                ‚Ä¢ Pas de backend
            </td>
            <td style="padding: 0.75rem;">
                ‚Ä¢ Performances<br>
                ‚Ä¢ Rendu approximatif<br>
                ‚Ä¢ CORS / fonts
            </td>
        </tr>
        <tr style="border-bottom: 1px solid var(--border-color);">
            <td style="padding: 0.75rem;"><strong>window.print()</strong></td>
            <td style="padding: 0.75rem;">
                ‚Ä¢ Utilisateur accepte d'imprimer<br>
                ‚Ä¢ Headers/footers non bloquants<br>
                ‚Ä¢ Rendu ultra fid√®le
            </td>
            <td style="padding: 0.75rem;">
                ‚Ä¢ Pas programmable<br>
                ‚Ä¢ Headers/footers impos√©s<br>
                ‚Ä¢ Action utilisateur requise
            </td>
        </tr>
        <tr>
            <td style="padding: 0.75rem;"><strong>Backend (Xano + Puppeteer)</strong></td>
            <td style="padding: 0.75rem;">
                ‚Ä¢ Rendu professionnel exig√©<br>
                ‚Ä¢ Documents officiels<br>
                ‚Ä¢ G√©n√©ration fr√©quente<br>
                ‚Ä¢ Email / stockage / archive
            </td>
            <td style="padding: 0.75rem;">
                ‚Ä¢ N√©cessite un backend<br>
                ‚Ä¢ Complexit√© accrue
            </td>
        </tr>
    </tbody>
</table>

<h2>üö® Pi√®ges √† √©viter (r√©sum√© rapide)</h2>

<ul>
    <li>‚ùå <code>scale: 2</code> par d√©faut</li>
    <li>‚ùå PNG syst√©matique (pr√©f√©rer JPEG)</li>
    <li>‚ùå Capturer un container g√©ant</li>
    <li>‚ùå Pas de lock / debounce sur le bouton</li>
    <li>‚ùå Pas de timeout sur html2canvas</li>
    <li>‚ùå D√©pendre du rendu responsive pour un PDF</li>
    <li>‚ùå Croire que <code>window.print()</code> est programmable</li>
</ul>

<!-- Final summary -->
<div class="summary">
üìå <strong>√Ä retenir :</strong>
<ul>
    <li>La g√©n√©ration de PDF c√¥t√© front n'est jamais "gratuite" : soit tu acceptes des compromis (perf, fid√©lit√©), soit tu passes par un backend</li>
    <li>Le script du cours (<code>html2canvas + jsPDF</code>) fonctionne conceptuellement, mais n√©cessite des adaptations s√©rieuses pour √™tre utilisable en production</li>
    <li>Toujours utiliser un lock d'ex√©cution, des timeouts, et optimiser les param√®tres (<code>scale: 1-1.25</code>, JPEG, cibler le bon √©l√©ment)</li>
    <li>Pour des documents critiques (factures, contrats), privil√©gier un backend (Xano + Puppeteer)</li>
    <li><strong>La vraie comp√©tence, ce n'est pas coller un script, c'est comprendre o√π √ßa casse et pourquoi.</strong></li>
</ul>
</div>

<h2>üîó Liens utiles</h2>

<ul>
    <li><a href="https://github.com/niklasvh/html2canvas" target="_blank" rel="noopener">html2canvas - Documentation officielle</a></li>
    <li><a href="https://github.com/parallax/jsPDF" target="_blank" rel="noopener">jsPDF - Documentation officielle</a></li>
    <li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/print" target="_blank" rel="noopener">MDN - window.print()</a></li>
</ul>
