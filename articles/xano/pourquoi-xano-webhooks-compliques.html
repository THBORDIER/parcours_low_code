<h1>Pourquoi Xano rend les webhooks si compliqu√©s (et comment s'en sortir)</h1>

<div class="metadata">
    <p>üè∑Ô∏è <strong>Cat√©gorie:</strong> Xano</p>
    <p>üéØ <strong>Niveau:</strong> Avanc√©</p>
    <p>üîç <strong>Mots-cl√©s:</strong> Get All Raw Input, input.body vide, webhook payload, JSON parsing, Stripe webhook, Missing param, ERROR_CODE_NOT_FOUND, raw_input, checkout.session.completed, UPDATE BDD, Debugging Xano</p>
    <p>üìÖ <strong>Mise √† jour:</strong> 03/12/2024</p>
    <p>‚è±Ô∏è <strong>Temps pass√©:</strong> 2h</p>
    <p>‚öôÔ∏è <strong>Stack:</strong> WeWeb + Xano + Stripe</p>
</div>

<div class="tldr">
‚úÖ <strong>TL;DR :</strong>
Dans Xano, <code>input.body</code> est souvent vide sur les webhooks entrants, m√™me si le JSON est visible dans l'historique. La solution : utiliser le bloc <strong>"Get All Raw Input"</strong> (cach√©, mal document√©) puis assigner <code>body = raw_input</code>. Oui, c'est absurde. Oui, √ßa fonctionne.
</div>

<h2>ü§¨ Le contexte : 2 heures pour une op√©ration qui devrait prendre 5 minutes</h2>

<p>J'avais un webhook Stripe fonctionnel. Le payload arrivait bien dans Xano. Je le voyais dans l'historique des requ√™tes. Tout semblait parfait.</p>

<p>Sauf que rien ne fonctionnait.</p>

<ul>
    <li>Mon <code>IF body.type == "checkout.session.completed"</code> ? Toujours faux.</li>
    <li>Mon <code>body.data.object.metadata.reservation_id</code> ? Undefined.</li>
    <li>Mon UPDATE en base ? Jamais ex√©cut√©.</li>
</ul>

<p>Le plus frustrant : <strong>aucune erreur explicite</strong>. Xano te laisse croire que tout va bien alors que rien ne passe.</p>

<h2>üîç Le probl√®me r√©el : <code>input.body</code> est vide</h2>

<p>Apr√®s des heures de debug, j'ai d√©couvert le coupable :</p>

<pre><code>input.body = {}</code></pre>

<p>Le body du webhook est <strong>visible dans l'historique Xano</strong>, mais <strong>inaccessible en logique workflow</strong>.</p>

<p>Pourquoi ? Parce que Xano ne mappe pas automatiquement le body des webhooks entrants. Le JSON est re√ßu, stock√© pour l'historique, mais jamais pars√© dans <code>input</code>.</p>

<div class="callout callout-warning">
‚ö†Ô∏è <strong>Le pi√®ge visuel</strong><br>
Tu vois le JSON complet dans l'onglet "Request History" de Xano. Tu penses logiquement pouvoir l'utiliser via <code>input.body</code>. C'est faux. Ce comportement n'est document√© nulle part de mani√®re claire.
</div>

<h2>‚úÖ La solution : "Get All Raw Input"</h2>

<p>La solution existe, mais elle est cach√©e dans un bloc que personne n'utilise spontan√©ment.</p>

<h3>√âtape 1 : Ajouter le bloc "Get All Raw Input"</h3>

<p>Dans ton workflow Xano :</p>
<ol>
    <li>Cliquer sur <strong>+ Add Function</strong></li>
    <li>Chercher <strong>"Get All Raw Input"</strong></li>
    <li>L'ajouter en tout d√©but de workflow</li>
</ol>

<p>Ce bloc r√©cup√®re le payload brut de la requ√™te et le stocke dans une variable (par d√©faut <code>raw_input</code>).</p>

<h3>√âtape 2 : Assigner le body</h3>

<p>Cr√©er une variable :</p>
<pre><code>body = raw_input</code></pre>

<p>Note importante : <code>json_parse</code> est g√©n√©ralement inutile. Xano renvoie d√©j√† un objet, pas une string JSON.</p>

<h3>√âtape 3 : Utiliser les donn√©es normalement</h3>

<p>Maintenant, tout fonctionne :</p>

<pre><code>// Condition sur le type d'√©v√©nement
IF body.type == "checkout.session.completed"

// Acc√®s aux donn√©es
body.data.object.metadata.reservation_id
body.data.object.customer_details.email
body.data.object.amount_total</code></pre>

<h2>üóÑÔ∏è UPDATE BDD : les pi√®ges suivants</h2>

<p>Une fois le body accessible, j'ai voulu mettre √† jour ma r√©servation en base. Nouveaux probl√®mes.</p>

<h3>Erreur 1 : <code>Missing param: field_value</code></h3>

<p>Cette erreur appara√Æt quand le bloc "Edit Record" n'a pas ses param√®tres correctement mapp√©s.</p>

<p><strong>Configuration correcte :</strong></p>
<pre><code>Table : reservation
field_name : id
field_value : body.data.object.metadata.reservation_id</code></pre>

<div class="callout callout-tip">
‚ú® <strong>Astuce</strong><br>
<code>field_name</code> = le nom de la colonne sur laquelle filtrer (ici <code>id</code>)<br>
<code>field_value</code> = la valeur √† chercher (ici l'ID de r√©servation depuis le webhook)
</div>

<h3>Erreur 2 : <code>ERROR_CODE_NOT_FOUND</code></h3>

<p>L'ID existe pourtant en base ! Le probl√®me : le type de donn√©es.</p>

<p>Le <code>reservation_id</code> dans le webhook Stripe est une string. L'<code>id</code> en base est un integer.</p>

<p><strong>Solution : cast en entier</strong></p>
<pre><code>field_value : (body.data.object.metadata.reservation_id|to_int)</code></pre>

<p>Apr√®s ce cast, l'UPDATE fonctionne enfin :</p>
<pre><code>status : "valide"</code></pre>

<h2>üò§ Critique objective de l'ergonomie Xano</h2>

<p>Apr√®s cette exp√©rience, voici mon verdict honn√™te sur Xano et les webhooks :</p>

<h3>Ce qui ne va pas</h3>

<table>
    <thead>
        <tr>
            <th>Probl√®me</th>
            <th>Impact</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Le body est visible mais inutilisable</td>
            <td>Faux positif, perte de temps √©norme</td>
        </tr>
        <tr>
            <td>Aucun mapping automatique du payload</td>
            <td>Comportement non intuitif</td>
        </tr>
        <tr>
            <td>Obligation d'utiliser "Get All Raw Input"</td>
            <td>Bloc cach√©, mal document√©</td>
        </tr>
        <tr>
            <td>Aucune erreur quand <code>input.body</code> est vide</td>
            <td>Debugging √† l'aveugle</td>
        </tr>
        <tr>
            <td>Erreurs g√©n√©riques ("Missing param", "Not found")</td>
            <td>Aucun contexte utile</td>
        </tr>
        <tr>
            <td>L'UI laisse croire que tout fonctionne</td>
            <td>Confiance mal plac√©e</td>
        </tr>
    </tbody>
</table>

<h3>Mon verdict</h3>

<div class="callout callout-warning">
‚ö†Ô∏è <strong>Conclusion</strong><br>
Xano est fonctionnel, mais l'ergonomie des webhooks est objectivement mauvaise, opaque, et fait perdre des heures pour une logique qui devrait prendre 5 minutes. Le produit fonctionne, l'exp√©rience d√©veloppeur est catastrophique.
</div>

<h2>‚úÖ Workflow final fonctionnel</h2>

<p>Pour r√©f√©rence, voici le workflow complet qui fonctionne :</p>

<pre><code>1. Get All Raw Input ‚Üí raw_input
2. Set Variable: body = raw_input
3. IF body.type == "checkout.session.completed"
   ‚îî‚îÄ 4. Edit Record (reservation)
         - field_name: id
         - field_value: (body.data.object.metadata.reservation_id|to_int)
         - status: "valide"
5. Return 200 OK</code></pre>

<h2>üìä R√©capitulatif des √©tats</h2>

<table>
    <thead>
        <tr>
            <th>√âtape</th>
            <th>Statut</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Paiement Stripe</td>
            <td>‚úÖ OK</td>
        </tr>
        <tr>
            <td>Webhook Stripe ‚Üí Xano</td>
            <td>‚úÖ OK</td>
        </tr>
        <tr>
            <td>Lecture du JSON (via raw_input)</td>
            <td>‚úÖ OK</td>
        </tr>
        <tr>
            <td>D√©tection checkout.session.completed</td>
            <td>‚úÖ OK</td>
        </tr>
        <tr>
            <td>R√©cup√©ration reservation_id</td>
            <td>‚úÖ OK</td>
        </tr>
        <tr>
            <td>UPDATE BDD r√©servation</td>
            <td>‚úÖ OK</td>
        </tr>
    </tbody>
</table>

<div class="summary">
üìå <strong>√Ä retenir :</strong>
<ul>
    <li><code>input.body</code> est souvent vide sur les webhooks Xano ‚Äî c'est "normal" (malheureusement)</li>
    <li>Utilise <strong>"Get All Raw Input"</strong> pour r√©cup√©rer le payload r√©el</li>
    <li>Assigne <code>body = raw_input</code> (pas besoin de json_parse)</li>
    <li>Cast les IDs en entier si n√©cessaire : <code>(value|to_int)</code></li>
    <li>Les erreurs Xano sont g√©n√©riques ‚Äî debug en v√©rifiant chaque variable manuellement</li>
</ul>
</div>

<h2>üîó Liens utiles</h2>

<ul>
    <li><a href="#" data-article="../articles/xano/webhook-stripe-xano-brevo.html">Article : Webhook Stripe ‚Üí Xano ‚Üí Email Brevo (configuration technique)</a></li>
    <li><a href="#" data-article="../articles/xano/flux-complet-weweb-xano-stripe-brevo.html">Article : Flux complet WeWeb ‚Üí Xano ‚Üí Stripe ‚Üí Brevo</a></li>
    <li><a href="#" data-article="../articles/xano/integration-stripe-checkout.html">Article : Int√©grer Stripe Checkout avec Xano</a></li>
    <li><a href="https://docs.xano.com/" target="_blank">Documentation officielle Xano</a></li>
</ul>
