<h1>IntÃ©grer Stripe Checkout avec Xano : rÃ©solution des erreurs courantes</h1>

<div class="metadata">
    <p>ğŸ·ï¸ <strong>CatÃ©gorie:</strong> Xano</p>
    <p>ğŸ¯ <strong>Niveau:</strong> IntermÃ©diaire</p>
    <p>ğŸ” <strong>Mots-clÃ©s:</strong> Stripe Checkout, External API Request, Headers key/value, URL-encoded, Variables d'environnement, $env, Payment Session</p>
    <p>ğŸ“… <strong>Mise Ã  jour:</strong> 26/11/2025</p>
    <p>â±ï¸ <strong>Temps passÃ©:</strong> 1h</p>
    <p>âš™ï¸ <strong>Stack:</strong> WeWeb + Xano + Stripe</p>
</div>

<div class="tldr">
âœ… <strong>TL;DR :</strong>
Pour intÃ©grer Stripe Checkout avec Xano : (1) les headers doivent Ãªtre en format key/value et non text[], (2) le body doit Ãªtre en <code>application/x-www-form-urlencoded</code> et non JSON, (3) la clÃ© API doit Ãªtre stockÃ©e dans <code>$env.STRIPE_SECRET_KEY</code>.
</div>

<h2>ğŸ¤” Contexte et objectif</h2>

<p>L'objectif Ã©tait d'intÃ©grer Stripe Checkout dans une API Xano afin de :</p>

<ul>
    <li>CrÃ©er une session de paiement depuis Xano</li>
    <li>Transmettre les <code>line_items</code>, le montant, la devise et les URLs de redirection</li>
    <li>Obtenir en rÃ©ponse l'URL Checkout Stripe</li>
    <li>Rediriger l'utilisateur vers cette page pour finaliser le paiement</li>
</ul>

<p>L'idÃ©e Ã©tait d'avoir une intÃ©gration propre, sÃ©curisÃ©e, utilisant les variables d'environnement Xano, et compatible avec les bonnes pratiques Stripe.</p>

<h2>ğŸ›‘ ProblÃ¨mes rencontrÃ©s</h2>

<p>Pendant cette intÃ©gration, plusieurs obstacles techniques se sont accumulÃ©s :</p>

<h3>ProblÃ¨me 1 : Les headers n'apparaissaient pas sous forme key/value</h3>

<p>Xano ne proposait pas sa structure normale :</p>

<pre><code>Key:
Value:</code></pre>

<p>Ã€ la place, le champ <code>headers</code> apparaissait comme un simple tableau <code>text[]</code>, ce qui empÃªchait l'ajout correct de headers HTTP.</p>

<h3>ProblÃ¨me 2 : Impossible de transmettre correctement la clÃ© Stripe</h3>

<p>En utilisant :</p>

<pre><code>Authorization: Bearer {{clÃ©}}</code></pre>

<p>Stripe renvoyait :</p>

<pre><code>Invalid API Key provided: {{sk_test_...}}</code></pre>

<p>Ã€ cause du mauvais type du champ headers, Xano envoyait littÃ©ralement les accolades <code>{{ }}</code> dans la requÃªte au lieu d'interprÃ©ter la variable.</p>

<h3>ProblÃ¨me 3 : Erreurs internes Xano</h3>

<p>Des erreurs comme <code>"Text filter requires a stringâ€¦"</code> apparaissaient lors des tentatives de concatÃ©nation du header avec une variable, car :</p>

<ul>
    <li>La valeur n'Ã©tait pas reconnue comme un texte</li>
    <li>La variable d'environnement n'Ã©tait pas prise en compte</li>
</ul>

<h2>ğŸ” Analyse des causes</h2>

<p>Les difficultÃ©s Ã©taient causÃ©es par trois Ã©lÃ©ments :</p>

<ol>
    <li><strong>Le champ headers avait Ã©tÃ© converti par erreur en <code>text[]</code></strong>, ce qui empÃªchait Xano d'utiliser son format natif key/value.</li>
    <li><strong>Les variables Xano entre <code>{{ }}</code> ne sont pas interprÃ©tÃ©es</strong> dans les headers de type <code>text[]</code>.</li>
    <li><strong>Stripe Checkout nÃ©cessite obligatoirement un body en <code>application/x-www-form-urlencoded</code></strong> et un header Authorization correctement formatÃ©.</li>
</ol>

<div class="callout callout-warning">
âš ï¸ <strong>Attention</strong><br>
Si vos headers apparaissent comme un tableau <code>text[]</code> au lieu du format key/value avec les champs <code>Key:</code> et <code>Value:</code>, Xano n'interprÃ©tera pas vos variables. C'est souvent la cause des erreurs "Invalid API Key".
</div>

<h2>ğŸ”§ Solutions apportÃ©es</h2>

<h3>Solution 1 : RecrÃ©ation propre de l'External API Request</h3>

<p>La requÃªte API a Ã©tÃ© supprimÃ©e puis recrÃ©Ã©e proprement, ce qui a permis Ã  Xano de restaurer la bonne structure du champ headers.</p>

<p>Xano a alors rÃ©-affichÃ© :</p>

<pre><code>+ Add Header
 Key:
 Value:</code></pre>

<p>Ce qui a permis d'ajouter correctement les headers.</p>

<div class="callout callout-tip">
âœ¨ <strong>Astuce</strong><br>
Lorsqu'un champ Xano est du mauvais type, il vaut mieux recrÃ©er l'Ã©tape plutÃ´t que de tenter de la rÃ©parer. Cela prend 2 minutes et Ã©vite des heures de dÃ©bogage.
</div>

<h3>Solution 2 : Utilisation des variables d'environnement Xano</h3>

<p>Pour Ã©viter les problÃ¨mes avec les accolades <code>{{ }}</code>, la clÃ© Stripe a Ã©tÃ© stockÃ©e dans les variables d'environnement Xano :</p>

<pre><code>$env.STRIPE_SECRET_KEY</code></pre>

<p>Dans le header Authorization, on configure :</p>

<ul>
    <li><strong>Key:</strong> <code>Authorization</code></li>
    <li><strong>Value:</strong> <code>Bearer </code> suivi de la valeur de la clÃ© (via le sÃ©lecteur de variable)</li>
</ul>

<p>En XanoScript, cela peut s'Ã©crire :</p>

<pre><code>"Authorization: Bearer " ~ $env.STRIPE_SECRET_KEY</code></pre>

<h3>Solution 3 : Formatage correct du body Stripe</h3>

<p>Stripe Checkout n'accepte pas le JSON. Le body doit Ãªtre en URL-encoded, avec des clÃ©s complexes :</p>

<pre><code>line_items[0][price_data][currency] = eur
line_items[0][price_data][unit_amount] = 5000
line_items[0][price_data][product_data][name] = Nom du produit
line_items[0][quantity] = 1
mode = payment
success_url = https://monsite.com/success
cancel_url = https://monsite.com/cancel</code></pre>

<div class="callout callout-advanced">
ğŸ”¬ <strong>Pour aller plus loin</strong><br>
Le format <code>application/x-www-form-urlencoded</code> est diffÃ©rent du JSON. Au lieu d'envoyer <code>{"line_items": [{"price_data": {"currency": "eur"}}]}</code>, on envoie <code>line_items[0][price_data][currency]=eur</code>. C'est un format plat oÃ¹ les objets imbriquÃ©s sont reprÃ©sentÃ©s par des crochets.
</div>

<h3>Solution 4 : Validation finale</h3>

<p>La requÃªte reÃ§ue par Stripe Ã©tait dÃ©sormais correcte :</p>

<ul>
    <li>Headers valides</li>
    <li>Body conforme au format URL-encoded</li>
    <li>ClÃ© Stripe interprÃ©tÃ©e correctement</li>
    <li>Content-Type correct</li>
</ul>

<p>Stripe a retournÃ© :</p>

<pre><code>HTTP/2 200
object: checkout.session
status: open
url: https://checkout.stripe.com/c/pay/...</code></pre>

<h2>ğŸ§ª Exemple concret</h2>

<h3>Configuration de l'External API Request dans Xano</h3>

<p><strong>URL :</strong></p>
<pre><code>https://api.stripe.com/v1/checkout/sessions</code></pre>

<p><strong>Method :</strong> POST</p>

<p><strong>Headers :</strong></p>
<pre><code>Key: Authorization
Value: Bearer [sÃ©lectionner $env.STRIPE_SECRET_KEY]

Key: Content-Type
Value: application/x-www-form-urlencoded</code></pre>

<p><strong>Body (URL-encoded) :</strong></p>
<pre><code>line_items[0][price_data][currency]=eur
line_items[0][price_data][unit_amount]=5000
line_items[0][price_data][product_data][name]=Mon Produit
line_items[0][quantity]=1
mode=payment
success_url=https://monsite.com/success?session_id={CHECKOUT_SESSION_ID}
cancel_url=https://monsite.com/cancel</code></pre>

<p><strong>RÃ©ponse attendue :</strong></p>
<pre><code>{
  "id": "cs_test_...",
  "object": "checkout.session",
  "url": "https://checkout.stripe.com/c/pay/cs_test_..."
}</code></pre>

<p>Cette URL peut Ãªtre utilisÃ©e par ton front-end (WeWeb, Webflow, FlutterFlow, Next.js, etc.) pour envoyer l'utilisateur vers la page de paiement.</p>

<div class="summary">
ğŸ“Œ <strong>Ã€ retenir :</strong>
<ul>
    <li>Dans Xano, les headers doivent absolument Ãªtre en format key/value, pas en <code>text[]</code></li>
    <li>Stripe Checkout requiert le format <code>application/x-www-form-urlencoded</code>, pas du JSON</li>
    <li>Les clÃ©s d'API doivent Ãªtre stockÃ©es en variables d'environnement (<code>$env</code>)</li>
    <li>Lorsqu'un champ Xano est du mauvais type, recrÃ©er l'Ã©tape plutÃ´t que de la rÃ©parer</li>
    <li>Une fois correctement paramÃ©trÃ©, Stripe Checkout fonctionne immÃ©diatement et renvoie une session complÃ¨te</li>
</ul>
</div>

<h2>ğŸ§  Quiz rapide</h2>

<p><strong>Question :</strong> Pourquoi Stripe renvoie-t-il "Invalid API Key provided: {{sk_test_...}}" ?</p>

<p><strong>RÃ©ponse attendue :</strong> Parce que les headers sont en format <code>text[]</code> au lieu de key/value, ce qui empÃªche Xano d'interprÃ©ter les variables. Les accolades <code>{{ }}</code> sont envoyÃ©es littÃ©ralement au lieu d'Ãªtre remplacÃ©es par la valeur de la clÃ©.</p>

<h2>ğŸ”— Liens utiles</h2>

<ul>
    <li><a href="https://stripe.com/docs/api/checkout/sessions/create" target="_blank">Documentation Stripe - CrÃ©er une session Checkout</a></li>
    <li><a href="https://docs.xano.com/working-with-data/external-api-requests" target="_blank">Documentation Xano - External API Requests</a></li>
    <li><a href="https://docs.xano.com/xano-features/settings/environment-variables" target="_blank">Documentation Xano - Variables d'environnement</a></li>
</ul>
