<h1>G√©n√©ration de devis dynamiques avec WeWeb et Xano</h1>

<p class="subtitle">Dans cet article, je vais expliquer comment construire un syst√®me complet de g√©n√©ration de devis PDF dans WeWeb connect√© √† Xano, en ma√Ætrisant le ciblage DOM et le format A4.</p>

<!-- Metadata block -->
<div class="metadata">
    <p>üè∑Ô∏è <strong>Cat√©gorie:</strong> Notes diverses</p>
    <p>üéØ <strong>Niveau:</strong> Interm√©diaire</p>
    <p>üîç <strong>Mots-cl√©s:</strong> PDF Generation, window.print(), querySelector, data-attributes, A4 format, WeWeb JavaScript, Devis dynamique, DOM targeting</p>
    <p>üìÖ <strong>Mise √† jour:</strong> 17/01/2025</p>
    <p>‚è±Ô∏è <strong>Temps pass√©:</strong> 1h</p>
    <p>‚öôÔ∏è <strong>Stack:</strong> WeWeb + Xano</p>
</div>

<!-- TL;DR -->
<div class="tldr">
‚úÖ <strong>TL;DR :</strong>
Pour g√©n√©rer un PDF propre depuis WeWeb : (1) utiliser des attributs <code>data-*</code> pour cibler le div, (2) ouvrir une fen√™tre temporaire, (3) imposer un format A4 avec <code>@page</code>, (4) auto-scale le contenu si n√©cessaire. Solution valid√©e sans plugin externe.
</div>

<h2>ü§î Probl√®me rencontr√©</h2>

<p><strong>üõë Contexte :</strong></p>
<p>L'objectif √©tait de construire un syst√®me complet de g√©n√©ration de devis dans une application no-code WeWeb, connect√© √† un backend Xano, permettant :</p>

<ul>
    <li>de r√©cup√©rer dynamiquement les donn√©es m√©tier (devis, client, produits)</li>
    <li>d'effectuer les calculs (quantit√©s, montants HT, TVA, total √† payer)</li>
    <li>d'afficher un devis fid√®le √† un format A4</li>
    <li>puis de g√©n√©rer un PDF propre et imprimable √† partir d'un div pr√©cis, et non de l'int√©gralit√© de la page</li>
</ul>

<p><strong>üí° Probl√©matiques rencontr√©es :</strong></p>
<ol>
    <li><strong>window.print()</strong> imprimait toute la page (header, footer, navigation)</li>
    <li>Dimensions A4 non respect√©es selon le navigateur</li>
    <li>Impossibilit√© de cibler uniquement le composant devis dans WeWeb</li>
    <li>Rendu visuel variable et non ma√Ætris√©</li>
</ol>

<h2>üèóÔ∏è Architecture globale</h2>

<h3>Front-end : WeWeb</h3>

<ul>
    <li>Construction visuelle du devis dans un composant <code>Div_PDF</code></li>
    <li>Utilisation de r√©p√©teurs pour afficher dynamiquement les lignes de produits</li>
    <li>Liaison directe aux donn√©es retourn√©es par l'API Xano</li>
    <li>Calculs r√©alis√©s c√¥t√© front pour l'affichage (montants, totaux)</li>
</ul>

<h3>Back-end : Xano</h3>

<p>Les donn√©es sont structur√©es autour de plusieurs tables :</p>

<ul>
    <li><strong>P10_devis</strong> : Informations principales du devis (num√©ro, objet, statut, montant, client li√©)</li>
    <li><strong>P10_client</strong> : Donn√©es l√©gales et de contact du client (raison sociale, adresse, SIRET, t√©l√©phone)</li>
    <li><strong>P10_panierDevis</strong> : Table pivot entre devis et produits, avec les quantit√©s</li>
    <li><strong>P10_produit</strong> : Catalogue produit (nom, description, prix HT, TVA)</li>
</ul>

<p>Un endpoint Xano permet de r√©cup√©rer un devis complet √† partir de son <code>id</code>, avec :</p>
<ul>
    <li>Mise √† jour du montant si n√©cessaire</li>
    <li>R√©cup√©ration des relations (client + lignes de panier)</li>
    <li>Retour d'un objet structur√© c√¥t√© front</li>
</ul>

<h2>üîç Construction du devis c√¥t√© WeWeb</h2>

<h3>Assemblage des donn√©es</h3>

<ul>
    <li>Le devis principal est charg√© via l'endpoint <code>GET /p10_devis/{id}</code></li>
    <li>Les informations client sont affich√©es √† partir de la relation <code>client_id</code></li>
    <li>Les lignes de devis sont affich√©es via un r√©p√©teur bas√© sur <code>P10_panierDevis</code></li>
</ul>

<p>Chaque ligne r√©cup√®re :</p>
<ul>
    <li>le produit li√©</li>
    <li>la quantit√©</li>
    <li>le prix unitaire</li>
    <li>le total de ligne calcul√© dynamiquement</li>
</ul>

<h3>Calculs effectu√©s</h3>

<pre><code>Total HT par ligne = quantit√© √ó tarif_HT
Total HT global = somme des lignes
TVA calcul√©e selon le produit
Net √† payer affich√© dans le bloc de synth√®se</code></pre>

<div class="callout callout-tip">
‚ú® <strong>Astuce</strong><br>
Ces calculs sont faits c√¥t√© front pour garantir r√©activit√©, coh√©rence visuelle et facilit√© de mise en page.
</div>

<h2>üß™ Solution : G√©n√©ration du PDF ma√Ætris√©e</h2>

<h3>√âtape 1Ô∏è‚É£ : Cibler le div pr√©cis dans WeWeb</h3>

<p><strong>‚ùå Erreur initiale :</strong></p>
<ul>
    <li>Tentative d'utilisation de <code>id="data-pdf"</code></li>
    <li>S√©lecteur JS recherchant <code>[data-pdf="devis"]</code></li>
    <li>‚û°Ô∏è Le div n'√©tait jamais trouv√© (<code>querySelector</code> retournait <code>null</code>)</li>
</ul>

<p><strong>‚úÖ Solution adopt√©e :</strong></p>

<p>Utilisation d'un attribut HTML personnalis√© dans le composant <code>Div_PDF</code> :</p>

<pre><code>HTML Attributes:
  data-pdf = devis</code></pre>

<p>Puis en JavaScript :</p>

<pre><code>document.querySelector('[data-pdf="devis"]')</code></pre>

<div class="callout callout-tip">
‚ú® <strong>Bonne pratique</strong><br>
Cette approche est stable, non modifi√©e par WeWeb, et conforme aux standards HTML (<code>data-*</code>).
</div>

<h3>√âtape 2Ô∏è‚É£ : Imposer un format A4</h3>

<p><strong>Probl√®me :</strong> M√™me apr√®s avoir cibl√© le div, le contenu apparaissait trop large, le rendu ne correspondait pas au visuel WeWeb, certaines colonnes d√©bordaient.</p>

<p><strong>Cause technique :</strong></p>
<ul>
    <li><code>window.print()</code> d√©pend du viewport et du CSS courant</li>
    <li>Absence de contraintes explicites en mm</li>
    <li>Styles globaux WeWeb non appliqu√©s dans une nouvelle fen√™tre</li>
</ul>

<h3>√âtape 3Ô∏è‚É£ : Script final valid√©</h3>

<p>La solution retenue repose sur :</p>
<ul>
    <li>L'ouverture d'une fen√™tre temporaire</li>
    <li>L'injection uniquement du HTML du devis</li>
    <li>L'imposition stricte d'un format A4</li>
    <li>Un auto-scale si le contenu d√©passe la largeur utile</li>
</ul>

<pre><code>const selector = '[data-pdf="devis"]';
const div = document.querySelector(selector);

if (!div) {
  console.error("Div PDF introuvable");
  return;
}

const printWindow = window.open("", "_blank");
if (!printWindow) {
  console.error("Popup bloqu√©e");
  return;
}

printWindow.document.open();
printWindow.document.write(`
  &lt;html&gt;
    &lt;head&gt;
      &lt;title&gt;Devis&lt;/title&gt;
      &lt;meta charset="utf-8" /&gt;
      &lt;style&gt;
        @page { size: A4; margin: 10mm; }

        html, body {
          margin: 0;
          padding: 0;
          background: #fff;
          font-family: Arial, Helvetica, sans-serif;
          -webkit-print-color-adjust: exact;
          print-color-adjust: exact;
        }

        .page {
          width: 190mm;
          margin: 0 auto;
        }

        * { box-sizing: border-box; }
        img { max-width: 100%; height: auto; }

        .avoid-break { break-inside: avoid; page-break-inside: avoid; }
      &lt;/style&gt;
    &lt;/head&gt;
    &lt;body&gt;
      &lt;div class="page" id="pageRoot"&gt;
        ${div.outerHTML}
      &lt;/div&gt;

      &lt;script&gt;
        (function () {
          function mmToPx(mm) {
            return mm * (96 / 25.4);
          }

          function fitToPage() {
            const page = document.getElementById("pageRoot");
            if (!page) return;

            const target = mmToPx(190);
            const contentWidth = page.scrollWidth;

            if (contentWidth &gt; target) {
              const scale = target / contentWidth;
              page.style.transformOrigin = "top left";
              page.style.transform = "scale(" + scale + ")";
              page.style.width = (190 / scale) + "mm";
            }
          }

          window.onload = function () {
            fitToPage();
            setTimeout(function () {
              window.print();
              window.close();
            }, 300);
          };
        })();
      &lt;/script&gt;
    &lt;/body&gt;
  &lt;/html&gt;
`);
printWindow.document.close();
printWindow.focus();</code></pre>

<div class="callout callout-advanced">
üî¨ <strong>Pour aller plus loin</strong><br>
La fonction <code>fitToPage()</code> calcule automatiquement le ratio de scale n√©cessaire pour que le contenu tienne dans les 190mm de largeur utile A4. Cela garantit un rendu optimal m√™me si le contenu WeWeb √©volue.
</div>

<h2>üß≠ R√©sultat final</h2>

<p><strong>‚úÖ Avantages de cette solution :</strong></p>

<ul>
    <li>G√©n√©ration d'un PDF uniquement √† partir du devis</li>
    <li>Dimensions A4 respect√©es</li>
    <li>Mise en page stable</li>
    <li>Compatible WeWeb / navigateur</li>
    <li>Aucun plugin externe requis</li>
    <li>Solution maintenable et √©volutive</li>
</ul>

<div class="callout callout-warning">
‚ö†Ô∏è <strong>Attention</strong><br>
Assurez-vous que les bloqueurs de popups sont d√©sactiv√©s pour l'application, sinon <code>window.open()</code> √©chouera silencieusement.
</div>

<!-- Final summary -->
<div class="summary">
üìå <strong>√Ä retenir :</strong>
<ul>
  <li>Utiliser des attributs <code>data-*</code> pour cibler pr√©cis√©ment un composant WeWeb</li>
  <li>Imposer un format A4 avec <code>@page { size: A4; margin: 10mm; }</code></li>
  <li>Auto-scale le contenu si n√©cessaire avec <code>transform: scale()</code></li>
  <li><code>window.print()</code> peut √™tre ma√Ætris√© sans plugin externe</li>
  <li>Une approche hybride no-code + JavaScript reste souvent la plus robuste</li>
</ul>
</div>

<h2>üéì Quiz rapide</h2>

<p><strong>üß† Question :</strong> Pourquoi utiliser <code>data-pdf="devis"</code> plut√¥t qu'un <code>id="devis"</code> dans WeWeb ?</p>

<p><strong>‚úÖ R√©ponse attendue :</strong> Les attributs <code>data-*</code> sont des attributs HTML personnalis√©s standard qui ne sont pas modifi√©s par WeWeb lors du rendu. Un <code>id</code> classique pourrait √™tre renomm√© ou alt√©r√© par le builder no-code, ce qui rendrait le <code>querySelector</code> instable.</p>

<h2>üîó Liens utiles</h2>

<ul>
    <li><a href="https://developer.mozilla.org/fr/docs/Web/CSS/@page" target="_blank">Documentation MDN : @page CSS</a></li>
    <li><a href="https://developer.mozilla.org/fr/docs/Web/HTML/Global_attributes/data-*" target="_blank">Documentation MDN : Attributs data-*</a></li>
    <li><a href="https://docs.weweb.io/" target="_blank">Documentation WeWeb</a></li>
    <li><a href="https://docs.xano.com/" target="_blank">Documentation Xano</a></li>
</ul>
