<h1>Journal de bord ‚Äì Projet 10 : Authentification et calcul automatique des devis</h1>

<p>Ce journal documente la mise en place de l'authentification compl√®te avec r√©cup√©ration des donn√©es utilisateur, l'affichage d'un tableau de devis, et la cr√©ation d'un syst√®me de calcul automatique des montants TTC.</p>

<!-- Metadata block -->
<div class="metadata">
    <p>üè∑Ô∏è <strong>Cat√©gorie:</strong> Notes diverses</p>
    <p>üéØ <strong>Niveau:</strong> Interm√©diaire</p>
    <p>üîç <strong>Mots-cl√©s:</strong> auth/me, Authentication, Custom Function, update_montant_devis, Relations, Query All Records, WeWeb Datagrid, formatDate, Calcul TTC, Panier</p>
    <p>üìÖ <strong>Mise √† jour:</strong> 16/01/2026</p>
    <p>‚è±Ô∏è <strong>Temps pass√©:</strong> 2h</p>
    <p>‚öôÔ∏è <strong>Stack:</strong> WeWeb + Xano</p>
</div>

<!-- TL;DR -->
<div class="tldr">
‚úÖ <strong>TL;DR :</strong>
R√©solution du probl√®me d'authentification incompl√®te en configurant correctement l'endpoint <code>/auth/me</code>, mise en place d'un tableau de devis avec formatage des donn√©es, et cr√©ation d'une fonction Xano pour calculer automatiquement les montants TTC √† partir des paniers.
</div>

<h2>üõë 1. Probl√®me initial : donn√©es utilisateur incompl√®tes apr√®s authentification</h2>

<h3>Constat</h3>
<p>Apr√®s une authentification r√©ussie depuis WeWeb vers Xano :</p>
<ul>
    <li>‚úÖ L'utilisateur √©tait bien connect√©</li>
    <li>‚úÖ Le token √©tait valide</li>
    <li>‚ùå Mais toutes les colonnes de la table <code>user</code> n'√©taient pas disponibles dans l'√©tat d'authentification WeWeb (<code>XANO AUTH</code>)</li>
</ul>

<p>Certaines donn√©es m√©tier importantes n'√©taient pas accessibles :</p>
<ul>
    <li><code>credit</code></li>
    <li><code>entreprise</code></li>
</ul>

<p>Pourtant, ces donn√©es existaient bien en base de donn√©es Xano.</p>

<h3>Analyse</h3>
<p>Le probl√®me ne venait ni :</p>
<ul>
    <li>‚ùå des tables Xano</li>
    <li>‚ùå de la connexion WeWeb ‚Üî Xano</li>
    <li>‚ùå de l'endpoint <code>/auth/login</code></li>
</ul>

<div class="callout callout-warning">
‚ö†Ô∏è <strong>D√©couverte importante</strong><br>
WeWeb n'hydrate pas l'utilisateur connect√© √† partir du login, mais √† partir de l'endpoint <code>GET /auth/me</code>.
</div>

<p>Or :</p>
<ul>
    <li>‚úÖ L'endpoint <code>/auth/me</code> existait</li>
    <li>‚ùå Mais son sch√©ma de r√©ponse ne contenait pas toutes les colonnes n√©cessaires</li>
</ul>

<h2>‚úÖ Solution appliqu√©e c√¥t√© Xano</h2>

<h3>Configuration de l'endpoint <code>GET /auth/me</code></h3>

<p><strong>√âtape 1 : R√©cup√©ration de l'utilisateur</strong></p>
<ul>
    <li>Utilisation de <code>Get Record From user</code></li>
</ul>

<p><strong>√âtape 2 : Enrichissement conditionnel</strong></p>
<ul>
    <li>R√©cup√©ration du r√¥le (<code>role</code>)</li>
    <li>R√©cup√©ration de l'entreprise li√©e (<code>entreprise</code>)</li>
    <li>Mise √† jour de la variable <code>user</code> avec les relations</li>
</ul>

<p><strong>√âtape 3 : Configuration de la r√©ponse</strong></p>
<ul>
    <li>Response configur√©e sur : <code>As Self ‚Üí var: user</code></li>
</ul>

<p><strong>√âtape 4 : Ajout explicite des champs dans Output / Response</strong></p>
<ul>
    <li><code>credit</code></li>
    <li><code>entreprise</code></li>
    <li><code>_entreprise_by_user</code> (relation √©tendue)</li>
</ul>

<h3>R√©sultat</h3>
<ul>
    <li>‚úÖ WeWeb r√©cup√®re d√©sormais un objet utilisateur complet</li>
    <li>‚úÖ L'√©tat <code>XANO AUTH.user</code> contient toutes les donn√©es n√©cessaires</li>
    <li>‚úÖ Les donn√©es sont disponibles dans toute l'application sans requ√™te suppl√©mentaire</li>
</ul>

<div class="callout callout-tip">
‚ú® <strong>Apprentissage cl√©</strong><br>
S√©paration claire des responsabilit√©s :<br>
‚Ä¢ <code>/auth/login</code> = s√©curit√© (validation, token)<br>
‚Ä¢ <code>/auth/me</code> = donn√©es utilisateur (hydratation compl√®te)
</div>

<h2>üìä 2. Mise en place du tableau des devis (WeWeb Datagrid)</h2>

<h3>Objectif</h3>
<p>Afficher une liste de devis avec :</p>
<ul>
    <li>Num√©ro de devis</li>
    <li>Client</li>
    <li>Date format√©e</li>
    <li>Montant TTC</li>
    <li>Statut</li>
</ul>

<h3>Donn√©es sources</h3>
<p><strong>Endpoint Xano :</strong></p>
<pre><code>GET /p10_devis</code></pre>

<p><strong>Tables impliqu√©es :</strong></p>
<ul>
    <li><code>P10_devis</code></li>
    <li><code>P10_client</code></li>
    <li><code>P10_panierDevis</code></li>
    <li><code>P10_produit</code></li>
</ul>

<h3>Probl√®me : format des donn√©es dans le tableau</h3>

<p><strong>Date</strong></p>
<ul>
    <li>Le champ <code>created_at</code> est stock√© sous forme de timestamp</li>
</ul>

<p><strong>Solution (WeWeb ‚Äì Datagrid, colonne Date) :</strong></p>
<pre><code>formatDate(mapping.item.created_at, "D/MM/YYYY")</code></pre>

<p><strong>Client</strong></p>
<ul>
    <li>Le nom du client provient d'une relation</li>
</ul>

<p><strong>Solution :</strong></p>
<ul>
    <li>Utilisation directe de : <code>mapping.nom</code></li>
</ul>

<h2>üí∞ 3. Calcul du montant TTC d'un devis (logique m√©tier)</h2>

<h3>Probl√®me</h3>
<p>Le montant total d'un devis d√©pend :</p>
<ul>
    <li>Des lignes de panier (<code>P10_panierDevis</code>)</li>
    <li>Des produits associ√©s (<code>P10_produit</code>)</li>
    <li>Des quantit√©s</li>
    <li>Du prix HT</li>
    <li>De la TVA</li>
</ul>

<p>Il n'√©tait pas stock√© automatiquement dans la table <code>P10_devis</code>.</p>

<h2>‚öôÔ∏è 4. Cr√©ation de la fonction <code>update_montant_devis</code></h2>

<h3>Objectif</h3>
<p>Calculer dynamiquement le montant TTC d'un devis √† partir de son panier.</p>

<h3>Description de la fonction (Xano ‚Äì Custom Function)</h3>

<p><strong>Nom :</strong> <code>update_montant_devis</code></p>

<p><strong>Input :</strong></p>
<ul>
    <li><code>devis_id</code> (integer)</li>
</ul>

<p><strong>Logique interne :</strong></p>

<p><strong>√âtape 1 : R√©cup√©ration de toutes les lignes du panier</strong></p>
<pre><code>Query All Records From P10_panierDevis</code></pre>

<p><strong>√âtape 2 : Initialisation d'une variable</strong></p>
<pre><code>montant = 0</code></pre>

<p><strong>√âtape 3 : Boucle sur chaque ligne du panier</strong></p>
<ul>
    <li>R√©cup√©ration du produit li√© (<code>P10_produit</code>)</li>
    <li>Calcul ligne par ligne :</li>
</ul>
<pre><code>quantite * (tarif_HT + tarif_HT * (TVA / 100))</code></pre>
<ul>
    <li>Addition du r√©sultat dans <code>montant</code></li>
</ul>

<p><strong>√âtape 4 : Mise √† jour du devis</strong></p>
<pre><code>Edit Record in P10_devis
‚Üí montant = montant</code></pre>

<p><strong>Valeur retourn√©e :</strong></p>
<pre><code>As Self ‚Üí var: montant</code></pre>

<div class="callout callout-tip">
‚ú® <strong>Bonne pratique</strong><br>
Centralisation de la logique m√©tier dans Xano via des Custom Functions. Cela garantit que le calcul est toujours coh√©rent, quel que soit le point d'entr√©e (API, webhook, etc.).
</div>

<h2>üîÑ 5. Int√©gration dans l'endpoint de r√©cup√©ration des devis</h2>

<p><strong>Dans l'endpoint :</strong></p>
<pre><code>GET /p10_devis</code></pre>

<h3>√âtapes</h3>
<ol>
    <li>Boucle sur chaque devis</li>
    <li>Appel de la fonction <code>update_montant_devis</code> (synchrone)</li>
    <li>Mise √† jour du champ <code>montant</code></li>
    <li>Retour de la liste des devis enrichis</li>
</ol>

<div class="callout callout-advanced">
üî¨ <strong>Pour aller plus loin</strong><br>
Le syst√®me de mise √† jour automatique fonctionne √©galement lors de l'√©volution des paniers ou des changements de prix des articles. √Ä chaque modification, la fonction recalcule le montant en temps r√©el.
</div>

<h2>üìå R√©sultat final</h2>

<div class="summary">
üìå <strong>√Ä retenir :</strong>
<ul>
    <li><strong>Authentification compl√®te et fiable</strong> : L'endpoint <code>/auth/me</code> hydrate correctement l'utilisateur dans WeWeb avec toutes les donn√©es m√©tier</li>
    <li><strong>Tableau de devis op√©rationnel</strong> : Donn√©es format√©es proprement c√¥t√© WeWeb (dates, relations)</li>
    <li><strong>Montant TTC calcul√© dynamiquement</strong> : Coh√©rent avec le panier gr√¢ce √† une Custom Function Xano</li>
    <li><strong>Logique m√©tier centralis√©e</strong> : Utilisation des Custom Functions pour garantir la coh√©rence des calculs</li>
</ul>
</div>

<h2>üß† M√©thodologie acquise</h2>

<ul>
    <li><strong>Compr√©hension du r√¥le r√©el de <code>/auth/me</code></strong> : Ce n'est pas le login qui hydrate l'utilisateur, mais bien cet endpoint</li>
    <li><strong>Importance du sch√©ma de r√©ponse Xano</strong> : Toujours v√©rifier l'onglet Output / Response pour s'assurer que tous les champs n√©cessaires sont inclus</li>
    <li><strong>S√©paration claire</strong> :
        <ul>
            <li><code>login</code> = s√©curit√©</li>
            <li><code>me</code> = donn√©es utilisateur</li>
        </ul>
    </li>
    <li><strong>Centralisation de la logique m√©tier dans Xano</strong> : Les Custom Functions garantissent la coh√©rence des calculs</li>
    <li><strong>Utilisation efficace des formules WeWeb</strong> : <code>formatDate()</code> pour l'affichage, <code>mapping</code> pour les relations</li>
</ul>

<div class="callout callout-tip">
‚ú® <strong>Astuce finale</strong><br>
Lors de probl√®mes d'authentification o√π certaines donn√©es manquent, v√©rifier toujours l'endpoint <code>/auth/me</code> en premier. C'est lui qui d√©finit ce qui sera disponible dans l'√©tat <code>XANO AUTH</code> de WeWeb.
</div>
