<h1>Envoyer un devis par email avec Brevo (template + piÃ¨ce jointe)</h1>

<p class="subtitle">Dans cet article, je vais expliquer comment envoyer un email transactionnel via l'API Brevo depuis Xano, en utilisant un template personnalisÃ© et en attachant un PDF gÃ©nÃ©rÃ© dynamiquement, tout en Ã©vitant les piÃ¨ges courants de configuration.</p>

<!-- Metadata block -->
<div class="metadata">
    <p>ğŸ·ï¸ <strong>CatÃ©gorie:</strong> API & Backend</p>
    <p>ğŸ¯ <strong>Niveau:</strong> IntermÃ©diaire</p>
    <p>ğŸ” <strong>Mots-clÃ©s:</strong> Brevo API, Email transactionnel, Template Brevo, Attachment PDF, Params vs Attributes, API Request Xano</p>
    <p>ğŸ“… <strong>Mise Ã  jour:</strong> 31/01/2026</p>
    <p>â±ï¸ <strong>Temps passÃ©:</strong> 30 minutes</p>
    <p>âš™ï¸ <strong>Stack:</strong> Xano + Brevo</p>
</div>

<!-- TL;DR -->
<div class="tldr">
âœ… <strong>TL;DR :</strong>
Pour envoyer un email Brevo avec template depuis Xano : utilisez <code>params</code> pour injecter les variables dans le template (pas <code>to[]</code>), dÃ©structurez les objets fichiers Xano (<code>devis_pdf.url</code> et non <code>devis_pdf</code>), et respectez le format <code>attachment: [{url, name}]</code>.
</div>

<h2>ğŸ¤” ProblÃ¨me rencontrÃ©</h2>

<h3>ğŸ¯ Objectif</h3>

<p>Dans le cadre du projet 10, l'objectif Ã©tait d'envoyer automatiquement un devis PDF par email au client Ã  partir du backend Xano, en utilisant Brevo (ex-Sendinblue) avec :</p>

<ul>
    <li>Un template Brevo prÃ©dÃ©fini</li>
    <li>Des donnÃ©es personnalisÃ©es (nom client, rÃ©fÃ©rence devis)</li>
    <li>Le PDF du devis en piÃ¨ce jointe</li>
</ul>

<h3>ğŸ›‘ SymptÃ´mes</h3>

<p><strong>Ce qui fonctionnait :</strong></p>
<ul>
    <li>âœ… L'appel Ã  l'API Brevo rÃ©ussissait (code 201)</li>
    <li>âœ… L'email Ã©tait bien reÃ§u</li>
    <li>âœ… Le template Brevo Ã©tait dÃ©clenchÃ© (templateId OK)</li>
    <li>âœ… La variable <code>{{ contact.EMAIL }}</code> s'affichait</li>
</ul>

<p><strong>Ce qui ne fonctionnait pas :</strong></p>
<ul>
    <li>âŒ Les variables personnalisÃ©es (rÃ©fÃ©rence devis, nom) ne s'affichaient pas</li>
    <li>âŒ Impossible d'ajouter la piÃ¨ce jointe PDF</li>
    <li>âŒ Erreurs API successives : <code>Not numeric</code>, <code>invalid_parameter</code></li>
</ul>

<h2>ğŸ” Explication : comprendre l'API Brevo</h2>

<h3>ğŸ§  Les deux types de variables dans Brevo</h3>

<p>Brevo utilise deux sources de donnÃ©es distinctes dans les templates :</p>

<table>
    <thead>
        <tr>
            <th>Type</th>
            <th>Syntaxe template</th>
            <th>Source</th>
            <th>Usage</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><strong>Attributs contact</strong></td>
            <td><code>{{ contact.EMAIL }}</code></td>
            <td>Base de donnÃ©es Brevo</td>
            <td>DonnÃ©es permanentes du contact</td>
        </tr>
        <tr>
            <td><strong>ParamÃ¨tres API</strong></td>
            <td><code>{{ params.reference }}</code></td>
            <td>Payload de l'API call</td>
            <td>DonnÃ©es transactionnelles (devis, commande, etc.)</td>
        </tr>
    </tbody>
</table>

<div class="callout callout-tip">
âœ¨ <strong>Astuce : l'analogie du formulaire</strong><br>
<ul>
    <li><strong>Attributs contact</strong> = champs de profil (nom, email, tÃ©lÃ©phone) â†’ dÃ©jÃ  enregistrÃ©s dans Brevo</li>
    <li><strong>Params</strong> = donnÃ©es spÃ©cifiques Ã  cet envoi (numÃ©ro de commande, montant, date) â†’ envoyÃ©es Ã  chaque appel API</li>
</ul>
</div>

<h3>ğŸ“¦ Structure correcte d'un appel API Brevo</h3>

<pre><code>{
  "to": [                        // âš ï¸ Uniquement destinataires
    {
      "email": "client@example.com",
      "name": "Jean Dupont"
    }
  ],
  "templateId": 1,               // ID du template Brevo
  "params": {                    // âœ… Variables injectÃ©es dans le template
    "reference": "DEV-2024-001",
    "montant": "1500â‚¬",
    "pdf_url": "https://..."
  },
  "attachment": [                // âœ… PiÃ¨ces jointes
    {
      "url": "https://...",      // URL publique du fichier
      "name": "devis.pdf"        // Nom du fichier
    }
  ]
}
</code></pre>

<h2>âŒ Erreurs courantes (fausses pistes)</h2>

<h3>ğŸš« Erreur 1 â€” Mettre les variables mÃ©tier dans <code>to[]</code></h3>

<pre><code>// âŒ Mauvais
"to": [
  {
    "email": "client@example.com",
    "name": "Jean Dupont",
    "reference": "DEV-2024-001",  // âš ï¸ IgnorÃ© par Brevo
    "pdf": "..."                   // âš ï¸ IgnorÃ© par Brevo
  }
]
</code></pre>

<p><strong>Pourquoi Ã§a ne marche pas :</strong> Brevo ignore tous les champs de <code>to[]</code> sauf <code>email</code> et <code>name</code>.</p>

<h3>ğŸš« Erreur 2 â€” Envoyer l'objet fichier complet en piÃ¨ce jointe</h3>

<p>Dans Xano, un champ de type <code>attachment</code> retourne un objet complexe :</p>

<pre><code>{
  "access": "public",
  "path": "/uploads/2026/01/devis.pdf",
  "name": "devis.pdf",
  "url": "https://x0fl-XXXX.xano.io/vault/xxx/devis.pdf",
  "size": 123456,
  "mime": "application/pdf"
}
</code></pre>

<pre><code>// âŒ Mauvais
"attachment": [
  {
    "url": $P10_devis1.devis_pdf,  // âš ï¸ Envoie tout l'objet
    "name": "devis.pdf"
  }
]

// Erreur : "url is not valid in attachment"
</code></pre>

<p><strong>Solution :</strong> Extraire uniquement la propriÃ©tÃ© <code>url</code> :</p>

<pre><code>// âœ… Bon
"url": $P10_devis1.devis_pdf.url
</code></pre>

<h3>ğŸš« Erreur 3 â€” ConcatÃ©nation de chaÃ®nes avec <code>+</code></h3>

<pre><code>// âŒ Mauvais (dans le DSL Xano)
"name": "devis-" + reference + ".pdf"

// Erreur : "Not numeric"
</code></pre>

<p><strong>Pourquoi :</strong> Dans le DSL Xano (langage de manipulation de donnÃ©es), l'opÃ©rateur <code>+</code> est une addition numÃ©rique, pas une concatÃ©nation de chaÃ®nes.</p>

<div class="callout callout-warning">
âš ï¸ <strong>Attention</strong><br>
Pour concatÃ©ner des chaÃ®nes dans Xano, utilisez une fonction dÃ©diÃ©e ou passez directement la variable existante (<code>$P10_devis1.devis_pdf.name</code>).
</div>

<h2>âœ… Solution Ã©tape par Ã©tape</h2>

<h3>Ã‰tape 1ï¸âƒ£ : PrÃ©parer le template Brevo</h3>

<p>Dans votre interface Brevo (Campaigns â†’ Templates â†’ Transactional templates) :</p>

<ol>
    <li>CrÃ©er un template d'email</li>
    <li>Utiliser les variables <code>{{ params.xxx }}</code> dans le contenu :
        <pre><code>Bonjour {{ params.nom }},

Voici votre devis nÂ° {{ params.reference }}.

Vous pouvez le tÃ©lÃ©charger en piÃ¨ce jointe.

Cordialement,
L'Ã©quipe</code></pre>
    </li>
    <li>Noter l'ID du template (ex: <code>1</code>)</li>
</ol>

<h3>Ã‰tape 2ï¸âƒ£ : CrÃ©er l'API dans Xano</h3>

<p>CrÃ©er une API POST qui :</p>
<ol>
    <li>RÃ©cupÃ¨re les donnÃ©es du devis en base</li>
    <li>Utilise un addon pour joindre les donnÃ©es client</li>
    <li>Appelle l'API Brevo avec les bons paramÃ¨tres</li>
</ol>

<h3>Ã‰tape 3ï¸âƒ£ : Code Xano complet (solution finale)</h3>

<pre><code>query BREVO_devistoclient verb=POST {
  api_group = "P10_devis"

  input {
    int devis_id?
  }

  stack {
    // RÃ©cupÃ©rer le devis + donnÃ©es client
    db.get P10_devis {
      field_name = "id"
      field_value = $input.devis_id
      addon = [
        {
          name : "P10_client_by_devis"
          input: {P10_client_id: $output.client_id}
          as   : "_client_by_devis"
        }
      ]
    } as $P10_devis1

    // Appel API Brevo
    api.request {
      url = "https://api.brevo.com/v3/smtp/email"
      method = "POST"
      params = {}
        // ğŸ“§ Destinataire
        |set:"to":([]
          |push:({}
            |set:"email":$P10_devis1._client_by_devis.email
            |set:"name":$P10_devis1._client_by_devis.nom
          )
        )
        // ğŸ“ Template ID
        |set:"templateId":1

        // âœ… Variables injectÃ©es dans le template
        |set:"params":({}
          |set:"nom":$P10_devis1._client_by_devis.nom
          |set:"reference":$P10_devis1.reference
          |set:"pdf_url":$P10_devis1.devis_pdf.url
        )

        // ğŸ“ PiÃ¨ce jointe PDF
        |set:"attachment":([]
          |push:({}
            |set:"url":$P10_devis1.devis_pdf.url      // âš ï¸ .url, pas l'objet complet
            |set:"name":$P10_devis1.devis_pdf.name    // âš ï¸ .name
          )
        )

      headers = []
        |push:"api-key: xkeysib-XXXXXXXX"             // âš ï¸ Votre clÃ© API Brevo
        |push:"Content-Type: application/json"
        |push:"Accept: application/json"
    } as $output_brevo_request
  }

  response = $output_brevo_request
}
</code></pre>

<div class="callout callout-tip">
âœ¨ <strong>Astuce : tester l'API Brevo directement</strong><br>
Avant d'intÃ©grer dans Xano, testez votre payload dans un outil comme Postman ou l'API Explorer de Brevo pour valider la structure.
</div>

<h3>Ã‰tape 4ï¸âƒ£ : Obtenir la clÃ© API Brevo</h3>

<ol>
    <li>Aller dans Brevo â†’ Settings â†’ SMTP & API â†’ API Keys</li>
    <li>CrÃ©er une nouvelle clÃ© API (copier <code>xkeysib-...</code>)</li>
    <li>Remplacer <code>xkeysib-XXXXXXXX</code> dans le code ci-dessus</li>
</ol>

<div class="callout callout-warning">
âš ï¸ <strong>SÃ©curitÃ©</strong><br>
Ne jamais exposer votre clÃ© API Brevo cÃ´tÃ© frontend. Toujours faire l'appel depuis le backend (Xano).
</div>

<h2>ğŸ§­ Exemple de rÃ©sultat</h2>

<h3>RÃ©ponse API Brevo (succÃ¨s)</h3>

<pre><code>{
  "messageId": "&lt;202601311425.12345@smtp-relay.brevo.com&gt;",
  "code": "201"
}
</code></pre>

<h3>Email reÃ§u</h3>

<div class="figure">
    <pre><code>Ã€ : client@example.com
Objet : Votre devis nÂ° DEV-2024-001
PiÃ¨ce jointe : devis.pdf (245 Ko)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Bonjour Jean Dupont,

Voici votre devis nÂ° DEV-2024-001.

Vous pouvez le tÃ©lÃ©charger en piÃ¨ce jointe.

Cordialement,
L'Ã©quipe</code></pre>
    <p class="figure-caption">Exemple d'email reÃ§u avec template Brevo</p>
</div>

<h2>ğŸ”§ Debugging : vÃ©rifier le payload envoyÃ©</h2>

<p>Si l'email ne fonctionne pas comme prÃ©vu, ajoutez un log dans Xano pour voir exactement ce qui est envoyÃ© :</p>

<pre><code>// Juste avant api.request
log {
  message = "Payload Brevo"
  data = {
    to: $P10_devis1._client_by_devis.email,
    params: {
      nom: $P10_devis1._client_by_devis.nom,
      reference: $P10_devis1.reference
    },
    attachment_url: $P10_devis1.devis_pdf.url
  }
}
</code></pre>

<p>Consultez ensuite les logs dans Xano â†’ Logs pour analyser la structure exacte du payload.</p>

<h2>ğŸ“Œ Ã€ retenir</h2>

<div class="summary">
ğŸ“Œ <strong>Points clÃ©s :</strong>
<ul>
    <li><strong>to[]</strong> = uniquement destinataires (<code>email</code> + <code>name</code>), rien d'autre</li>
    <li><strong>params</strong> = toutes les variables injectÃ©es dans le template (<code>{{ params.xxx }}</code>)</li>
    <li><strong>Attributs contact</strong> (<code>{{ contact.XXX }}</code>) = base de donnÃ©es Brevo</li>
    <li><strong>Attachment</strong> = toujours <code>[{url: string, name: string}]</code></li>
    <li>DÃ©structurer les objets Xano : <code>devis_pdf.url</code> et non <code>devis_pdf</code></li>
    <li>Pas de concatÃ©nation avec <code>+</code> dans le DSL Xano (utiliser les propriÃ©tÃ©s directement)</li>
    <li>Toujours tester avec les logs Xano pour valider le payload envoyÃ©</li>
</ul>
</div>

<div class="callout callout-advanced">
ğŸ”¬ <strong>Pour aller plus loin</strong><br>
<ul>
    <li>GÃ©rer les erreurs Brevo (quotas, email invalide, etc.)</li>
    <li>Ajouter des webhooks Brevo pour tracer les ouvertures/clics</li>
    <li>Utiliser plusieurs piÃ¨ces jointes (devis + conditions gÃ©nÃ©rales)</li>
    <li>Personnaliser le <code>replyTo</code> et <code>sender</code></li>
    <li>Envoyer des emails en copie (cc/bcc)</li>
    <li>Utiliser des templates conditionnels selon le type de client</li>
</ul>
</div>

<h2>ğŸ“ Quiz rapide</h2>

<p><strong>ğŸ§  Question :</strong> Pourquoi la variable <code>{{ params.reference }}</code> ne s'affiche pas dans le template Brevo alors que <code>{{ contact.EMAIL }}</code> fonctionne ?</p>

<details>
    <summary>âœ… Voir la rÃ©ponse</summary>
    <p>Parce que <code>{{ contact.EMAIL }}</code> provient de la base de donnÃ©es Brevo (attribut contact permanent), tandis que <code>{{ params.reference }}</code> doit Ãªtre envoyÃ© dynamiquement dans le champ <code>params</code> du payload API. Si <code>params</code> n'est pas correctement configurÃ© dans l'appel API, la variable reste vide dans le template.</p>
</details>

<h2>ğŸ”— Ressources utiles</h2>

<ul>
    <li><a href="https://developers.brevo.com/reference/sendtransacemail" target="_blank" rel="noopener">Brevo API : Send transactional email</a></li>
    <li><a href="https://help.brevo.com/hc/fr/articles/360000946299" target="_blank" rel="noopener">Brevo : Utiliser les variables dans les templates</a></li>
    <li><a href="https://docs.xano.com/working-with-data/api-request" target="_blank" rel="noopener">Xano Docs : API Request</a></li>
    <li><a href="#" data-article="../articles/api/generer-stocker-pdf-weweb-xano.html">Article : GÃ©nÃ©rer et stocker un PDF depuis WeWeb vers Xano</a></li>
    <li><a href="#" data-article="../articles/xano/webhook-stripe-xano-email-brevo.html">Article : Webhook Stripe â†’ Xano â†’ Email Brevo</a></li>
</ul>
