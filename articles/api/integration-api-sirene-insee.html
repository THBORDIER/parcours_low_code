<h1>Int√©grer l'API Sirene de l'INSEE avec Xano</h1>

<p class="subtitle">Comment r√©cup√©rer automatiquement les informations d'une entreprise fran√ßaise via son SIRET, en g√©rant les URLs d√©pr√©ci√©es, l'authentification par cl√© API, et surtout les limitations frustrantes de Xano.</p>

<!-- Metadata block -->
<div class="metadata">
    <p>üè∑Ô∏è <strong>Cat√©gorie:</strong> API & Backend</p>
    <p>üéØ <strong>Niveau:</strong> Interm√©diaire</p>
    <p>üîç <strong>Mots-cl√©s:</strong> API Sirene, INSEE, SIRET, SIREN, Authentication, API Key, Headers, Xano Function, Data mapping, Non-diffusion, Deprecated endpoints, Ternary operators</p>
    <p>üìÖ <strong>Mise √† jour:</strong> 21/01/2026</p>
    <p>‚è±Ô∏è <strong>Temps pass√©:</strong> 3h (dont 20min sur l'API, 2h40 √† contourner les limitations Xano...)</p>
    <p>‚öôÔ∏è <strong>Stack utilis√©e:</strong> Xano + API Sirene INSEE</p>
</div>

<!-- TL;DR -->
<div class="tldr">
‚úÖ <strong>TL;DR :</strong>
L'API Sirene de l'INSEE permet de r√©cup√©rer automatiquement les infos d'une entreprise (raison sociale, adresse, forme juridique) via son SIRET. L'int√©gration est simple (cl√© API dans le header), mais la documentation est obsol√®te (migration octobre 2024) et Xano interdit les structures de contr√¥le classiques (switch/if) ‚Üí il faut utiliser des ternaires imbriqu√©s. Certaines donn√©es peuvent √™tre masqu√©es ([ND]) si l'entreprise a demand√© la non-diffusion.
</div>

<h2>ü§î Probl√®me rencontr√©</h2>

<p><strong>üõë Besoin m√©tier :</strong></p>
<p>Dans une application de g√©n√©ration de devis (Projet 10), je veux simplifier la saisie des informations client. Au lieu de demander manuellement le nom, l'adresse, la forme juridique, etc., je veux que l'utilisateur entre juste son <strong>num√©ro SIRET</strong> et que tout se remplisse automatiquement.</p>

<p><strong>üí° Exemple utilisateur :</strong></p>
<ul>
    <li>L'utilisateur tape "12345678901234" dans le champ SIRET</li>
    <li>L'application interroge l'API INSEE</li>
    <li>Les champs "Raison sociale", "Adresse", "Code postal", "Ville", "Forme juridique" se remplissent automatiquement</li>
    <li>Gain de temps et r√©duction des erreurs de saisie</li>
</ul>

<h2>üîç Explication simplifi√©e</h2>

<h3>Qu'est-ce que l'API Sirene ?</h3>

<p>L'<strong>API Sirene</strong> est un service public gratuit fourni par l'INSEE qui permet d'acc√©der aux donn√©es du <strong>r√©pertoire SIRENE</strong> (base de donn√©es de toutes les entreprises fran√ßaises).</p>

<p><strong>üìä Donn√©es disponibles :</strong></p>
<ul>
    <li>‚úÖ SIRET (14 chiffres) et SIREN (9 chiffres)</li>
    <li>‚úÖ Raison sociale (nom de l'entreprise)</li>
    <li>‚úÖ Forme juridique (SARL, SAS, SASU, Auto-entrepreneur, etc.)</li>
    <li>‚úÖ Adresse compl√®te (n¬∞, type de voie, nom de voie, code postal, ville)</li>
    <li>‚ùå T√©l√©phone, email ‚Üí pas disponibles dans l'API</li>
</ul>

<p><strong>üß† Analogie :</strong> C'est comme un annuaire t√©l√©phonique, mais pour les entreprises. Tu donnes le num√©ro (SIRET), il te retourne la fiche compl√®te.</p>

<h3>Pourquoi c'est compliqu√© ?</h3>

<p>Trois obstacles principaux :</p>
<ol>
    <li><strong>Documentation obsol√®te</strong> : l'INSEE a migr√© son portail en octobre 2024. Beaucoup de tutoriels en ligne pointent vers des URLs d√©pr√©ci√©es.</li>
    <li><strong>Non-diffusion des donn√©es</strong> : certaines entreprises (surtout les auto-entrepreneurs) demandent √† masquer leurs donn√©es personnelles ‚Üí l'API retourne <code>[ND]</code> au lieu des valeurs r√©elles.</li>
    <li><strong>Limitations de Xano</strong> : impossible d'utiliser <code>switch</code> ou <code>if</code> dans les expressions ‚Üí il faut ruser avec des ternaires imbriqu√©s.</li>
</ol>

<div class="callout callout-warning">
‚ö†Ô∏è <strong>Attention</strong><br>
Si vous cherchez "API Sirene INSEE" sur Google, vous tomberez sur des tutoriels avec des URLs obsol√®tes (<code>https://api.insee.fr/token</code>, <code>https://api.insee.fr/entreprises/sirene/V3.11/...</code>). Ces endpoints ne fonctionnent plus depuis octobre 2024. L'URL correcte est : <code>https://api.insee.fr/api-sirene/3.11/siret/{siret}</code>
</div>

<h2>üß™ Solution : Cr√©er une fonction Xano</h2>

<h3>√âtape 1Ô∏è‚É£ : Cr√©er un compte sur le portail INSEE</h3>

<ol>
    <li>Aller sur <strong>https://portail-api.insee.fr</strong></li>
    <li>Cr√©er un compte (gratuit)</li>
    <li>Cr√©er une application (ex: "DevisPro")</li>
    <li>Souscrire √† l'API <strong>Sirene</strong></li>
    <li>R√©cup√©rer votre <strong>cl√© API d'int√©gration</strong> (format UUID)</li>
</ol>

<div class="callout callout-tip">
‚ú® <strong>Astuce</strong><br>
La cl√© API s'appelle officiellement "Cl√© d'int√©gration" (Consumer Key for integration). Ne confondez pas avec la "Cl√© de production" qui est pour les applications en production. Pour vos tests, utilisez la cl√© d'int√©gration.
</div>

<h3>√âtape 2Ô∏è‚É£ : Cr√©er la fonction Xano</h3>

<p>Dans Xano, cr√©ez une nouvelle <strong>Function</strong> (pas un API endpoint) :</p>

<ul>
    <li><strong>Nom :</strong> <code>P10_SIREN</code></li>
    <li><strong>Input :</strong> <code>SIRET</code> (type text)</li>
    <li><strong>Output :</strong> un objet avec les infos de l'entreprise</li>
</ul>

<h3>√âtape 3Ô∏è‚É£ : Ajouter une pr√©condition (validation)</h3>

<p>Avant d'appeler l'API, on v√©rifie que le SIRET a bien 14 chiffres :</p>

<pre><code>precondition (($input.SIRET|strlen) == 14) {
  error_type = "inputerror"
  error = "Le num√©ro SIRET doit comporter exactement 14 chiffres."
}</code></pre>

<h3>√âtape 4Ô∏è‚É£ : Appeler l'API Sirene</h3>

<p>Ajoutez un bloc <strong>API Request</strong> :</p>

<pre><code>api.request {
  url = `"https://api.insee.fr/api-sirene/3.11/siret/"| concat:$input.SIRET`
  method = "GET"
  headers = []
    |push:"accept: application/json"
    |push:"X-INSEE-Api-Key-Integration: a1b2c3d4-e5f6-7890-a1b2-c3d4e5f67890"
} as $api1</code></pre>

<div class="callout callout-warning">
‚ö†Ô∏è <strong>Remplacez la cl√© API</strong><br>
Remplacez <code>a1b2c3d4-e5f6-7890-a1b2-c3d4e5f67890</code> par votre vraie cl√© obtenue sur le portail INSEE. Ne partagez jamais votre cl√© publiquement.
</div>

<h3>√âtape 5Ô∏è‚É£ : Traduire le code forme juridique</h3>

<p>L'API retourne un <strong>code num√©rique</strong> pour la forme juridique (ex: <code>5710</code> = SAS, <code>1000</code> = Entrepreneur individuel). On veut le convertir en libell√© lisible.</p>

<p><strong>‚ùå Ce qui ne marche PAS dans Xano :</strong></p>

<pre><code>// ‚ùå Switch ‚Üí pas support√© dans les expressions
switch ($codeJuridique) {
  case "1000": return "Entrepreneur individuel"
  case "5499": return "SARL"
  ...
}

// ‚ùå If/else ‚Üí pas support√© dans les expressions
if ($codeJuridique == "1000") {
  return "Entrepreneur individuel"
} else if ($codeJuridique == "5499") {
  return "SARL"
}</code></pre>

<p><strong>‚úÖ Solution : ternaires imbriqu√©s</strong></p>

<pre><code>var $codeJuridique {
  value = $api1.response.result.etablissement.uniteLegale.categorieJuridiqueUniteLegale
}

var $formeJuridiqueLabel {
  value = $codeJuridique == "1000" ? "Entrepreneur individuel" :
          ($codeJuridique == "5499" ? "SARL" :
          ($codeJuridique == "5710" ? "SAS" :
          ($codeJuridique == "5720" ? "SASU" :
          ($codeJuridique == "6540" ? "SCI" :
          ($codeJuridique == "5498" ? "EURL" :
          ($codeJuridique == "5599" ? "SA" :
          ($codeJuridique == "9220" ? "Association" :
          $codeJuridique)))))))
}</code></pre>

<div class="callout callout-warning">
‚ö†Ô∏è <strong>Frustration : les limitations de Xano</strong><br>
Xano ne supporte ni <code>switch</code>, ni <code>if</code>, ni m√™me un syst√®me de lookup par objet (<code>{code: label}</code>). Vous √™tes oblig√© d'imbriquer des ternaires, ce qui rend le code illisible et difficile √† maintenir. C'est l'un des points les plus frustrants du low-code : vous √™tes "mains nou√©es" aux outils propos√©s, sans possibilit√© d'√©crire du code propre.
</div>

<h3>√âtape 6Ô∏è‚É£ : Construire la r√©ponse</h3>

<p>Retournez un objet structur√© avec tous les champs n√©cessaires :</p>

<pre><code>response = {
  SIRET              : $api1.response.result.etablissement.siret
  SIREN              : $api1.response.result.etablissement.siren
  nomEntreprise      : $api1.response.result.etablissement.uniteLegale.denominationUniteLegale
  formeJuridique     : $codeJuridique
  formeJuridiqueLabel: $formeJuridiqueLabel
  Nvoie              : $api1.response.result.etablissement.adresseEtablissement.numeroVoieEtablissement
  typevoie           : $api1.response.result.etablissement.adresseEtablissement.typeVoieEtablissement
  nomvoie            : $api1.response.result.etablissement.adresseEtablissement.libelleVoieEtablissement
  codepostal         : $api1.response.result.etablissement.adresseEtablissement.codePostalEtablissement
  ville              : $api1.response.result.etablissement.adresseEtablissement.libelleCommuneEtablissement
}</code></pre>

<h2>üß∞ Code complet de la fonction Xano</h2>

<pre><code>function P10_SIREN {
  input {
    text SIRET
  }

  stack {
    precondition (($input.SIRET|strlen) == 14) {
      error_type = "inputerror"
      error = "Le num√©ro SIRET doit comporter exactement 14 chiffres."
    }

    api.request {
      url = `"https://api.insee.fr/api-sirene/3.11/siret/"| concat:$input.SIRET`
      method = "GET"
      headers = []
        |push:"accept: application/json"
        |push:"X-INSEE-Api-Key-Integration: a1b2c3d4-e5f6-7890-a1b2-c3d4e5f67890"
    } as $api1

    var $codeJuridique {
      value = $api1.response.result.etablissement.uniteLegale.categorieJuridiqueUniteLegale
    }

    var $formeJuridiqueLabel {
      value = $codeJuridique == "1000" ? "Entrepreneur individuel" :
              ($codeJuridique == "5499" ? "SARL" :
              ($codeJuridique == "5710" ? "SAS" :
              ($codeJuridique == "5720" ? "SASU" :
              ($codeJuridique == "6540" ? "SCI" :
              ($codeJuridique == "5498" ? "EURL" :
              ($codeJuridique == "5599" ? "SA" :
              ($codeJuridique == "9220" ? "Association" :
              $codeJuridique)))))))
    }
  }

  response = {
    SIRET              : $api1.response.result.etablissement.siret
    SIREN              : $api1.response.result.etablissement.siren
    nomEntreprise      : $api1.response.result.etablissement.uniteLegale.denominationUniteLegale
    formeJuridique     : $codeJuridique
    formeJuridiqueLabel: $formeJuridiqueLabel
    Nvoie              : $api1.response.result.etablissement.adresseEtablissement.numeroVoieEtablissement
    typevoie           : $api1.response.result.etablissement.adresseEtablissement.typeVoieEtablissement
    nomvoie            : $api1.response.result.etablissement.adresseEtablissement.libelleVoieEtablissement
    codepostal         : $api1.response.result.etablissement.adresseEtablissement.codePostalEtablissement
    ville              : $api1.response.result.etablissement.adresseEtablissement.libelleCommuneEtablissement
  }
}</code></pre>

<h2>üß≠ Exemple de r√©ponse</h2>

<p>Lorsque vous testez la fonction avec le SIRET <code>12345678901234</code>, vous obtenez :</p>

<pre><code>{
  "infosiren": {
    "SIRET": "12345678901234",
    "SIREN": "123456789",
    "nomEntreprise": "DEMO SARL",
    "formeJuridique": "5499",
    "formeJuridiqueLabel": "SARL",
    "Nvoie": "42",
    "typevoie": "RUE",
    "nomvoie": "DE LA REPUBLIQUE",
    "codepostal": "69001",
    "ville": "LYON"
  }
}</code></pre>

<h2>‚ö†Ô∏è Cas particulier : la non-diffusion [ND]</h2>

<p>Certaines entreprises (notamment les <strong>entrepreneurs individuels</strong>) peuvent demander √† l'INSEE de ne pas diffuser leurs donn√©es personnelles. Dans ce cas, l'API retourne <code>[ND]</code> (Non Diffus√©) pour les champs sensibles.</p>

<p><strong>Exemple de r√©ponse avec non-diffusion :</strong></p>

<pre><code>{
  "infosiren": {
    "SIRET": "12345678901234",
    "SIREN": "123456789",
    "nomEntreprise": "[ND]",
    "formeJuridique": "1000",
    "formeJuridiqueLabel": "Entrepreneur individuel",
    "Nvoie": "[ND]",
    "typevoie": "[ND]",
    "nomvoie": "[ND]",
    "codepostal": "[ND]",
    "ville": "LYON"
  }
}</code></pre>

<p>Seule la ville reste diffus√©e (car c'est une donn√©e publique de niveau commune).</p>

<div class="callout callout-tip">
‚ú® <strong>Astuce : g√©rer les [ND] c√¥t√© frontend</strong><br>
Dans votre interface WeWeb, d√©tectez si les champs contiennent <code>[ND]</code> et affichez un message √† l'utilisateur : "Cette entreprise a demand√© la non-diffusion de ses donn√©es. Veuillez saisir manuellement les informations."
</div>

<h2>üöß Probl√®me fr√©quent : variable non accessible dans Edit Record</h2>

<p>Apr√®s avoir cr√©√© votre fonction, vous voulez l'utiliser dans un <strong>API endpoint</strong> pour remplir automatiquement un enregistrement de votre table <code>P10_client</code>.</p>

<p>Vous appelez la fonction :</p>

<pre><code>var $infosiren {
  value = function.P10_SIREN($input.SIRET)
}</code></pre>

<p>Mais dans le bloc <strong>Edit Record</strong>, le s√©lecteur visuel de Xano ne voit pas la structure de <code>$infosiren</code>. Vous ne pouvez pas faire <code>$infosiren.ville</code> avec le s√©lecteur.</p>

<p><strong>‚úÖ Solution 1 : Publier la fonction</strong></p>
<ol>
    <li>Votre fonction est en <strong>DRAFT</strong></li>
    <li>Cliquez sur "Review & Publish"</li>
    <li>R√©activez votre API endpoint</li>
    <li>Le s√©lecteur devrait maintenant voir la structure</li>
</ol>

<p><strong>‚úÖ Solution 2 : Saisie manuelle</strong></p>
<p>Si le s√©lecteur ne fonctionne toujours pas, tapez manuellement les expressions :</p>
<ul>
    <li><code>$infosiren.nomEntreprise</code></li>
    <li><code>$infosiren.ville</code></li>
    <li><code>$infosiren.codepostal</code></li>
    <li>etc.</li>
</ul>

<h2>üìã Tableau des codes forme juridique</h2>

<table>
    <thead>
        <tr>
            <th>Code</th>
            <th>Libell√©</th>
        </tr>
    </thead>
    <tbody>
        <tr><td>1000</td><td>Entrepreneur individuel</td></tr>
        <tr><td>5498</td><td>EURL</td></tr>
        <tr><td>5499</td><td>SARL</td></tr>
        <tr><td>5710</td><td>SAS</td></tr>
        <tr><td>5720</td><td>SASU</td></tr>
        <tr><td>5599</td><td>SA</td></tr>
        <tr><td>6540</td><td>SCI</td></tr>
        <tr><td>9220</td><td>Association</td></tr>
    </tbody>
</table>

<div class="callout callout-advanced">
üî¨ <strong>Pour aller plus loin</strong><br>
L'INSEE propose des centaines de codes forme juridique. Si vous avez besoin de tous les g√©rer, consultez la nomenclature compl√®te sur le site de l'INSEE, puis cr√©ez une <strong>table de r√©f√©rence</strong> dans Xano avec les codes et libell√©s. Vous pourrez ensuite faire un <code>Query All Records</code> avec filtre pour r√©cup√©rer le bon libell√©, au lieu d'utiliser des ternaires imbriqu√©s.
</div>

<!-- Final summary -->
<div class="summary">
üìå <strong>√Ä retenir :</strong>
<ul>
  <li>L'API Sirene de l'INSEE permet de r√©cup√©rer automatiquement les infos d'une entreprise via son SIRET (gratuit)</li>
  <li>URL correcte (2026) : <code>https://api.insee.fr/api-sirene/3.11/siret/{siret}</code></li>
  <li>Authentification : cl√© API dans le header <code>X-INSEE-Api-Key-Integration</code></li>
  <li>Certaines donn√©es peuvent √™tre masqu√©es (<code>[ND]</code>) si l'entreprise a demand√© la non-diffusion</li>
  <li>Xano ne supporte ni <code>switch</code> ni <code>if</code> ‚Üí utiliser des ternaires imbriqu√©s (frustrant mais fonctionnel)</li>
  <li>Pensez √† <strong>publier votre fonction</strong> avant de l'utiliser dans un API endpoint</li>
  <li>T√©l√©phone et email ne sont pas disponibles dans l'API ‚Üí saisie manuelle obligatoire</li>
</ul>
</div>

<h2>üîó Liens utiles</h2>

<ul>
    <li><a href="https://portail-api.insee.fr" target="_blank" rel="noopener">Portail API INSEE</a> ‚Äì Cr√©er un compte et obtenir une cl√©</li>
    <li><a href="https://api.insee.fr/catalogue/site/themes/wso2/subthemes/insee/pages/item-info.jag?name=Sirene&version=V3.11&provider=insee" target="_blank" rel="noopener">Documentation API Sirene V3.11</a></li>
    <li><a href="https://www.sirene.fr/sirene/public/accueil" target="_blank" rel="noopener">R√©pertoire Sirene</a> ‚Äì Recherche manuelle d'entreprises</li>
    <li><a href="https://www.insee.fr/fr/information/2028129" target="_blank" rel="noopener">Nomenclature des formes juridiques</a> ‚Äì Liste compl√®te des codes</li>
</ul>
